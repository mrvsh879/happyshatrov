<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Office Birds ‚Äî Level 1</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #06121f;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    /* –§–æ–Ω ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞ (–∫–∞–∫ —É —Ç–µ–±—è) */
    body {
      background-image: url("assets/bg_office.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    #wrap {
      position: fixed;
      inset: 0;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    .hud {
      position: fixed;
      left: 16px;
      top: 16px;
      z-index: 10;
      display: flex;
      gap: 12px;
      align-items: flex-start;
      pointer-events: none;
    }

    .panel {
      pointer-events: none;
      background: rgba(9, 18, 28, 0.55);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 10px 12px;
      color: rgba(255,255,255,0.92);
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      min-width: 240px;
    }

    .panel h1 {
      font-size: 14px;
      margin: 0 0 6px 0;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .panel small {
      display: block;
      opacity: 0.85;
      line-height: 1.3;
      font-size: 12px;
    }

    .btnbar {
      pointer-events: auto;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    button {
      pointer-events: auto;
      background: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.16);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      transition: transform .08s ease, background .15s ease;
      user-select: none;
    }

    button:hover { background: rgba(255,255,255,0.16); }
    button:active { transform: translateY(1px); }

    .right {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 10;
      width: 310px;
      pointer-events: none;
    }

    .kv {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px 10px;
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.92;
    }

    .kv div:nth-child(2n) {
      opacity: 0.95;
      font-weight: 800;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      z-index: 10;
      padding: 6px 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      background: rgba(0,0,0,0.40);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      backdrop-filter: blur(6px);
      pointer-events: none;
      opacity: 0;
      transition: opacity .18s ease;
    }
    .toast.show { opacity: 1; }
  </style>
</head>

<body>
  <div class="hud">
    <div class="panel">
      <h1><span style="opacity:.9">LEVEL 1</span> &nbsp; Office Birds</h1>
      <small>–ó–∞–∂–º–∏ –Ω–∞ —á–µ–ª–æ–≤–µ—á–∫–µ ‚Üí –ø–æ—Ç—è–Ω–∏ –Ω–∞–∑–∞–¥ ‚Üí –æ—Ç–ø—É—Å—Ç–∏.</small>
      <small>–ß–µ–º —Å–∏–ª—å–Ω–µ–µ –Ω–∞—Ç—è–∂–∫–∞, —Ç–µ–º –¥–∞–ª—å—à–µ –ø–æ–ª—ë—Ç.</small>
      <div class="kv">
        <div>–°—á—ë—Ç:</div><div id="score">0</div>
        <div>–°–ª–æ–º–∞–Ω–æ –±–∞–ª–æ–∫:</div><div id="broken">0</div>
        <div>–ü–æ–ø–∞–¥–∞–Ω–∏–π:</div><div id="hits">0</div>
      </div>
    </div>

    <div class="btnbar">
      <button id="resetBtn" title="–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å">Reset (–≤—Å—ë –∑–∞–Ω–æ–≤–æ)</button>
    </div>
  </div>

  <div class="right">
    <div class="panel">
      <h1>–¶–µ–ª—å</h1>
      <small>–†–∞–∑–≤–∞–ª–∏ –æ—Ñ–∏—Å–Ω—ã–π –¥–æ–º–∏–∫ (2 —ç—Ç–∞–∂–∞).</small>
      <small>–í–Ω—É—Ç—Ä–∏ —Å–∏–¥—è—Ç –º–µ–Ω–µ–¥–∂–µ—Ä—ã –≤ –Ω–∞—É—à–Ω–∏–∫–∞—Ö.</small>
      <small>–ü–æ—Å–ª–µ –≤—ã—Å—Ç—Ä–µ–ª–∞: 2‚Äì3 —Å–µ–∫ —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è ‚Üí –∞–≤—Ç–æ-—Ä–µ—Å–ø–∞–≤–Ω.</small>
      <small>–î–æ–º–∏–∫ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è (–ø–æ–ª–æ–º–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è).</small>
      <div class="kv">
        <div>–°—Ç–∞—Ç—É—Å:</div><div id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>
  </div>

  <div id="wrap">
    <canvas id="c"></canvas>
  </div>

  <div id="toast" class="toast">‚Ä¶</div>

  <!-- Matter.js -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

  <script>
    (function () {
      "use strict";

      // ---------- helpers ----------
      const $ = (id) => document.getElementById(id);
      const toastEl = $("toast");
      function toast(msg, ms = 1400) {
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        setTimeout(() => toastEl.classList.remove("show"), ms);
      }

      function loadImage(src) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error("–ù–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –∫–∞—Ä—Ç–∏–Ω–∫–∞: " + src));
          img.src = src + (src.includes("?") ? "&" : "?") + "v=" + Date.now();
        });
      }

      // ---------- assets ----------
      const ASSETS = {
        bg: "assets/bg_office.png",
        beam: "assets/office/beam.png",
        pillar: "assets/office/pillar.png",
        manager: "assets/office/manager.png",
        humanIdle: "assets/player/human_idle.png",
        humanFly: "assets/player/human_fly.png"
      };

      // ---------- Matter aliases ----------
      const {
        Engine, Render, Runner, World, Bodies, Body,
        Constraint, Mouse, MouseConstraint, Events, Composite
      } = Matter;

      // ---------- game state ----------
      let engine, world, render, runner;
      let mouseConstraint;

      let ground;
      let bird = null;
      let birdLaunched = false;
      let birdRespawnTimer = null;

      const structure = {
        pillars: [],
        beams: [],
        joints: [],
        managers: [],
        frozenUntil: 0
      };

      const stats = {
        score: 0,
        broken: 0,
        hits: 0
      };

      // break system
      const JOINT_BREAK_THRESHOLD = 7.0; // —á–µ–º –º–µ–Ω—å—à–µ ‚Äî —Ç–µ–º –ª–µ–≥—á–µ –ª–æ–º–∞–µ—Ç—Å—è
      const MANAGER_HIT_SPEED = 4.3;

      // layout tuning
      const LAYOUT = {
        // —Å—Ü–µ–Ω–∞
        floorHeight: 90,
        // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è —á–µ–ª–æ–≤–µ—á–∫–∞
        birdStartX: 160,
        birdStartYOffset: 170, // –æ—Ç –ø–æ–ª–∞ –≤–≤–µ—Ä—Ö
        // –¥–æ–º–∏–∫ (–∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ)
        houseCenterX: () => Math.round(window.innerWidth * 0.62),
        houseBaseY: () => Math.round(window.innerHeight - LAYOUT.floorHeight),
        houseWidth: 380,
        houseHeight: 260,
        // —ç—Ç–∞–∂–∏: –Ω–∏–∑/–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ/–≤–µ—Ä—Ö
        yBottomBeam: () => LAYOUT.houseBaseY() - 40,
        yMidBeam: () => LAYOUT.houseBaseY() - 140,
        yTopBeam: () => LAYOUT.houseBaseY() - 240,
        // –º–µ–Ω–µ–¥–∂–µ—Ä—ã (–≤–Ω—É—Ç—Ä–∏)
        managersCount: 3
      };

      // sprite scaling target (–≤ –ø–∏–∫—Å–µ–ª—è—Ö –Ω–∞ —ç–∫—Ä–∞–Ω–µ)
      const SPRITE_TARGET = {
        pillarH: 250,
        beamW: 360,
        birdWIdle: 130, // human_idle (–Ω–∞ —Å—Ç—É–ª–µ)
        birdWFly: 92,   // human_fly
        managerW: 78
      };

      // ---------- init ----------
      $("status").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤‚Ä¶";

      Promise.all([
        loadImage(ASSETS.beam),
        loadImage(ASSETS.pillar),
        loadImage(ASSETS.manager),
        loadImage(ASSETS.humanIdle),
        loadImage(ASSETS.humanFly),
        loadImage(ASSETS.bg).catch(() => null) // —Ñ–æ–Ω –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫ (–æ–Ω –≤ CSS)
      ]).then(([imgBeam, imgPillar, imgManager, imgIdle, imgFly]) => {
        const IMGS = { imgBeam, imgPillar, imgManager, imgIdle, imgFly };
        start(IMGS);
      }).catch((e) => {
        console.error(e);
        $("status").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PNG";
        toast("PNG –æ—à–∏–±–∫–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø—É—Ç–∏ assets/", 2500);
      });

      function start(IMGS) {
        $("status").textContent = "–ó–∞–ø—É—Å–∫‚Ä¶";

        const canvas = $("c");
        const wrap = $("wrap");

        engine = Engine.create();
        world = engine.world;
        world.gravity.y = 1.0;

        render = Render.create({
          element: wrap,
          canvas,
          engine,
          options: {
            width: window.innerWidth,
            height: window.innerHeight,
            wireframes: false,
            background: "transparent",
            pixelRatio: window.devicePixelRatio || 1
          }
        });

        runner = Runner.create();

        // ground
        ground = Bodies.rectangle(
          window.innerWidth / 2,
          window.innerHeight - LAYOUT.floorHeight / 2,
          window.innerWidth + 200,
          LAYOUT.floorHeight,
          {
            isStatic: true,
            friction: 0.9,
            restitution: 0.0,
            render: { fillStyle: "rgba(0,0,0,0)" }
          }
        );
        World.add(world, ground);

        // mouse control
        const mouse = Mouse.create(canvas);
        mouseConstraint = MouseConstraint.create(engine, {
          mouse,
          constraint: {
            stiffness: 0.18,
            damping: 0.08,
            render: { visible: false }
          }
        });
        World.add(world, mouseConstraint);
        render.mouse = mouse;

        // build level
        buildStructure(IMGS);
        spawnBird(IMGS, true);

        // events
        bindGameplay(IMGS);

        // render/run
        Render.run(render);
        Runner.run(runner, engine);

        // UI
        $("resetBtn").addEventListener("click", () => resetAll(IMGS));

        // resize
        window.addEventListener("resize", () => onResize(IMGS));

        $("status").textContent = "–ì–æ—Ç–æ–≤–æ";
        toast("–ì–æ—Ç–æ–≤–æ. –¢—è–Ω–∏ —á–µ–ª–æ–≤–µ—á–∫–∞ –∏ –æ—Ç–ø—É—Å–∫–∞–π üëç", 1600);
        updateHUD();
      }

      function updateHUD() {
        $("score").textContent = String(stats.score);
        $("broken").textContent = String(stats.broken);
        $("hits").textContent = String(stats.hits);
      }

      function onResize(IMGS) {
        if (!render) return;

        render.canvas.width = window.innerWidth;
        render.canvas.height = window.innerHeight;
        render.options.width = window.innerWidth;
        render.options.height = window.innerHeight;

        // –ø–µ—Ä–µ—Å–æ–∑–¥–∞–¥–∏–º –≤–µ—Å—å —É—Ä–æ–≤–µ–Ω—å, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å —Å–º–µ—â–µ–Ω–∏—è
        resetAll(IMGS);
      }

      function resetAll(IMGS) {
        // —Å—Ç–æ–ø —Ç–∞–π–º–µ—Ä–∞ —Ä–µ—Å–ø–∞–≤–Ω–∞
        if (birdRespawnTimer) {
          clearTimeout(birdRespawnTimer);
          birdRespawnTimer = null;
        }

        // –æ—á–∏—Å—Ç–∫–∞ –º–∏—Ä–∞
        Composite.clear(world, false);

        // –∑–∞–Ω–æ–≤–æ: –∑–µ–º–ª—è + –º—ã—à—å + –¥–æ–º–∏–∫ + bird
        World.add(world, ground);
        World.add(world, mouseConstraint);

        // stats
        stats.score = 0;
        stats.broken = 0;
        stats.hits = 0;
        updateHUD();

        // –æ—á–∏—Å—Ç–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        structure.pillars = [];
        structure.beams = [];
        structure.joints = [];
        structure.managers = [];
        structure.frozenUntil = 0;

        bird = null;
        birdLaunched = false;

        buildStructure(IMGS);
        spawnBird(IMGS, true);

        $("status").textContent = "–ì–æ—Ç–æ–≤–æ";
        toast("–£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω.", 1200);
      }

      // ---------- build structure ----------
      function buildStructure(IMGS) {
        const baseY = LAYOUT.houseBaseY();
        const cx = LAYOUT.houseCenterX();
        const w = LAYOUT.houseWidth;

        // pillars positions
        const leftX = cx - Math.round(w / 2);
        const rightX = cx + Math.round(w / 2);

        // sprite scale compute
        const pillarScale = SPRITE_TARGET.pillarH / IMGS.imgPillar.height;
        const beamScale = SPRITE_TARGET.beamW / IMGS.imgBeam.width;

        // pillar bodies (—Å—Ç–∞—Ç–∏—á–Ω—ã–µ ‚Äî —á—Ç–æ–±—ã –¥–æ–º–∏–∫ –Ω–µ –µ—Ö–∞–ª/–Ω–µ –ø–∞–¥–∞–ª —Å–∞–º)
        const pillarH = IMGS.imgPillar.height * pillarScale;
        const pillarW = IMGS.imgPillar.width * pillarScale;

        const pLeft = Bodies.rectangle(leftX, baseY - pillarH / 2, pillarW, pillarH, {
          isStatic: true,
          render: {
            sprite: {
              texture: ASSETS.pillar,
              xScale: pillarScale,
              yScale: pillarScale
            }
          }
        });

        const pRight = Bodies.rectangle(rightX, baseY - pillarH / 2, pillarW, pillarH, {
          isStatic: true,
          render: {
            sprite: {
              texture: ASSETS.pillar,
              xScale: pillarScale,
              yScale: pillarScale
            }
          }
        });

        structure.pillars.push(pLeft, pRight);

        // beams (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ, –Ω–æ —Å–Ω–∞—á–∞–ª–∞ "–∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã")
        const beamW = IMGS.imgBeam.width * beamScale;
        const beamH = IMGS.imgBeam.height * beamScale;

        const bTop = Bodies.rectangle(cx, LAYOUT.yTopBeam(), beamW, beamH, makeBeamOpts(beamScale));
        const bMid = Bodies.rectangle(cx, LAYOUT.yMidBeam(), beamW, beamH, makeBeamOpts(beamScale));
        const bBot = Bodies.rectangle(cx, LAYOUT.yBottomBeam(), beamW, beamH, makeBeamOpts(beamScale));

        structure.beams.push(bTop, bMid, bBot);

        // joints to pillars (–ª–æ–º–∞–µ–º—ã–µ)
        const joints = [];

        // helper create joint at local points
        function beamToPillarJoint(beam, pillar, offsetX) {
          // offsetX: -1 = left end, +1 = right end
          const px = offsetX * (beamW / 2 - 14);
          const joint = Constraint.create({
            bodyA: beam,
            pointA: { x: px, y: 0 },
            bodyB: pillar,
            pointB: { x: 0, y: 0 },
            stiffness: 0.9,
            damping: 0.05,
            length: 0,
            render: { visible: false }
          });
          joint.__breakable = true;
          joint.__broken = false;
          joints.push(joint);
          return joint;
        }

        // top
        beamToPillarJoint(bTop, pLeft, -1);
        beamToPillarJoint(bTop, pRight, +1);
        // mid
        beamToPillarJoint(bMid, pLeft, -1);
        beamToPillarJoint(bMid, pRight, +1);
        // bottom
        beamToPillarJoint(bBot, pLeft, -1);
        beamToPillarJoint(bBot, pRight, +1);

        structure.joints = joints;

        // managers: —Å—Ç–∞–≤–∏–º –Ω–∞ mid beam, —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ
        const managers = [];
        const mScale = SPRITE_TARGET.managerW / IMGS.imgManager.width;
        const mW = IMGS.imgManager.width * mScale;
        const mH = IMGS.imgManager.height * mScale;

        for (let i = 0; i < LAYOUT.managersCount; i++) {
          const t = (i + 1) / (LAYOUT.managersCount + 1);
          const x = cx - w * 0.28 + t * (w * 0.56);
          const y = LAYOUT.yMidBeam() - beamH / 2 - mH / 2 + 6;

          const m = Bodies.rectangle(x, y, mW, mH, {
            restitution: 0.1,
            friction: 0.9,
            frictionAir: 0.02,
            density: 0.002,
            render: {
              sprite: {
                texture: ASSETS.manager,
                xScale: mScale,
                yScale: mScale
              }
            }
          });

          m.__isManager = true;
          m.__alive = true;
          managers.push(m);
        }

        structure.managers = managers;

        // add to world
        World.add(world, [pLeft, pRight, bTop, bMid, bBot, ...joints, ...managers]);

        // "–Ω–µ —Ä–∞–∑–≤–∞–ª–∏–≤–∞—Ç—å—Å—è –Ω–∞ —Å—Ç–∞—Ä—Ç–µ": –∑–∞–º–æ—Ä–æ–∑–∫–∞ –∫–æ—Ä–æ—Ç–∫–æ (—Å–æ–Ω + –≤—Ä–µ–º–µ–Ω–Ω–æ –≥–∞—Å–∏–º —Å–∫–æ—Ä–æ—Å—Ç–∏)
        structure.frozenUntil = performance.now() + 700;
        for (const b of structure.beams) {
          Body.setVelocity(b, { x: 0, y: 0 });
          Body.setAngularVelocity(b, 0);
          b.isSleeping = true;
        }
        for (const m of structure.managers) {
          Body.setVelocity(m, { x: 0, y: 0 });
          Body.setAngularVelocity(m, 0);
          m.isSleeping = true;
        }
      }

      function makeBeamOpts(beamScale) {
        return {
          restitution: 0.05,
          friction: 0.9,
          frictionAir: 0.01,
          density: 0.0018,
          render: {
            sprite: {
              texture: ASSETS.beam,
              xScale: beamScale,
              yScale: beamScale
            }
          }
        };
      }

      // ---------- bird ----------
      function spawnBird(IMGS, fresh = false) {
        const baseY = window.innerHeight - LAYOUT.floorHeight;
        const x = LAYOUT.birdStartX;
        const y = baseY - LAYOUT.birdStartYOffset;

        const idleScale = SPRITE_TARGET.birdWIdle / IMGS.imgIdle.width;
        const flyScale = SPRITE_TARGET.birdWFly / IMGS.imgFly.width;

        // bird collider (–Ω–µ —Ä–∞–≤–µ–Ω –∫–∞—Ä—Ç–∏–Ω–∫–µ, —Ç–∞–∫ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ)
        const r = 26;

        bird = Bodies.circle(x, y, r, {
          restitution: 0.15,
          friction: 0.9,
          frictionAir: 0.012,
          density: 0.004,
          render: {
            sprite: {
              texture: ASSETS.humanIdle,
              xScale: idleScale,
              yScale: idleScale
            }
          }
        });

        bird.__flyTexture = ASSETS.humanFly;
        bird.__idleTexture = ASSETS.humanIdle;
        bird.__flyScale = flyScale;
        bird.__idleScale = idleScale;

        birdLaunched = false;

        World.add(world, bird);

        if (fresh) {
          $("status").textContent = "–ì–æ—Ç–æ–≤–æ";
        }
      }

      function setBirdIdle() {
        if (!bird) return;
        bird.render.sprite.texture = bird.__idleTexture;
        bird.render.sprite.xScale = bird.__idleScale;
        bird.render.sprite.yScale = bird.__idleScale;
      }

      function setBirdFly() {
        if (!bird) return;
        bird.render.sprite.texture = bird.__flyTexture;
        bird.render.sprite.xScale = bird.__flyScale;
        bird.render.sprite.yScale = bird.__flyScale;
      }

      // ---------- gameplay ----------
      function bindGameplay(IMGS) {
        // drag limit + launch
        Events.on(mouseConstraint, "startdrag", (e) => {
          if (!bird || e.body !== bird) return;
          if (birdLaunched) return;
          $("status").textContent = "–ù–∞—Ç—è–∂–∫–∞‚Ä¶";
        });

        Events.on(mouseConstraint, "enddrag", (e) => {
          if (!bird || e.body !== bird) return;
          if (birdLaunched) return;

          // launch vector: from start position to current, but reversed
          const baseY = window.innerHeight - LAYOUT.floorHeight;
          const start = { x: LAYOUT.birdStartX, y: baseY - LAYOUT.birdStartYOffset };
          const pos = bird.position;

          const dx = start.x - pos.x;
          const dy = start.y - pos.y;

          // clamp pull
          const pullMax = 130;
          const pull = Math.min(pullMax, Math.hypot(dx, dy));
          const k = pull / (Math.hypot(dx, dy) || 1);

          const ndx = dx * k;
          const ndy = dy * k;

          // power (—É–º–µ–Ω—å—à–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ —É–ª–µ—Ç–∞–ª –∑–∞ —ç–∫—Ä–∞–Ω)
          const power = 0.15; // –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ ‚Äî —ç—Ç–æ –º—è–≥—á–µ
          const vx = ndx * power;
          const vy = ndy * power;

          // –≤–µ—Ä–Ω—É—Ç—å –≤ —Å—Ç–∞—Ä—Ç –∏ –¥–∞—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–∞–∫ angry birds)
          Body.setPosition(bird, start);
          Body.setVelocity(bird, { x: vx, y: vy });
          Body.setAngularVelocity(bird, 0.18);

          birdLaunched = true;
          setBirdFly();

          $("status").textContent = "–ü–æ–ª–µ—Ç–µ–ª!";
          stats.score += 1;
          updateHUD();

          // 2.5 —Å–µ–∫ ‚Äú–ª–æ–º–∞–µ–º‚Äù, –∑–∞—Ç–µ–º —Ä–µ—Å–ø–∞–≤–Ω –ø—Ç–∏—Ü—ã (–¥–æ–º–∏–∫ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
          scheduleBirdRespawn(IMGS, 2500);
        });

        // collision ‚Äî –ª–æ–º–∞–µ–º joints + —Å—á–∏—Ç–∞–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏—è –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
        Events.on(engine, "collisionStart", (event) => {
          const now = performance.now();

          for (const pair of event.pairs) {
            const a = pair.bodyA;
            const b = pair.bodyB;

            // –º–µ–Ω–µ–¥–∂–µ—Ä hit
            if ((a.__isManager && b === bird) || (b.__isManager && a === bird)) {
              const m = a.__isManager ? a : b;
              const relSpeed = pair.collision && pair.collision.penetration
                ? Math.hypot(pair.collision.penetration.x, pair.collision.penetration.y)
                : 0;

              const v = bird ? Math.hypot(bird.velocity.x, bird.velocity.y) : 0;
              if (m.__alive && v > MANAGER_HIT_SPEED) {
                m.__alive = false;
                stats.hits += 1;
                stats.score += 25;
                updateHUD();
                toast("–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–ª—É—á–∏–ª –ø–æ KPI üòµ", 900);
              }
            }

            // joint breaking based on impact energy
            // —Å—á–∏—Ç–∞–µ–º "—É–¥–∞—Ä" –∫–∞–∫ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
            const va = Math.hypot(a.velocity.x, a.velocity.y);
            const vb = Math.hypot(b.velocity.x, b.velocity.y);
            const impact = Math.abs(va - vb);

            // –¥–æ–º–∏–∫ –∑–∞–º–æ—Ä–æ–∂–µ–Ω –Ω–∞ —Å—Ç–∞—Ä—Ç–µ ‚Äî –Ω–µ –ª–æ–º–∞–µ–º
            if (now < structure.frozenUntil) continue;

            if (impact > JOINT_BREAK_THRESHOLD) {
              tryBreakSomeJointNear(pair);
            }
          }
        });

        // before update: –¥–µ—Ä–∂–∏–º –¥–æ–º–∏–∫ –≤ ‚Äú—Å–Ω–µ‚Äù –ø–µ—Ä–≤—ã–µ 0.7s
        Events.on(engine, "beforeUpdate", () => {
          const now = performance.now();
          if (now < structure.frozenUntil) {
            // –≥–∞—Å–∏–º —Å–∫–æ—Ä–æ—Å—Ç—å —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–µ—Ö–∞–ª–æ
            for (const b of structure.beams) {
              Body.setVelocity(b, { x: 0, y: 0 });
              Body.setAngularVelocity(b, 0);
              b.isSleeping = true;
            }
            for (const m of structure.managers) {
              Body.setVelocity(m, { x: 0, y: 0 });
              Body.setAngularVelocity(m, 0);
              m.isSleeping = true;
            }
          }

          // –µ—Å–ª–∏ –ø—Ç–∏—Ü–∞ —É–ª–µ—Ç–µ–ª–∞ —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ ‚Äî —Ä–µ—Å–ø–∞–≤–Ω–∏–º —Ä–∞–Ω—å—à–µ
          if (bird && birdLaunched) {
            const out =
              bird.position.x < -200 ||
              bird.position.x > window.innerWidth + 200 ||
              bird.position.y > window.innerHeight + 400 ||
              bird.position.y < -400;

            if (out) {
              scheduleBirdRespawn(IMGS, 250);
            }
          }

          // –∫–æ–≥–¥–∞ –ø—Ç–∏—Ü–∞ –ø–æ—á—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å ‚Äî –≤–µ—Ä–Ω—É—Ç—å idle —Ç–µ–∫—Å—Ç—É—Ä—É (–µ—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ –∑–µ–º–ª–µ)
          if (bird && birdLaunched) {
            const speed = Math.hypot(bird.velocity.x, bird.velocity.y);
            if (speed < 0.35 && bird.position.y > window.innerHeight - LAYOUT.floorHeight - 220) {
              setBirdIdle();
            }
          }
        });

        // debug if needed:
        // console.log("Matter OK:", typeof Matter, Matter);
      }

      function scheduleBirdRespawn(IMGS, delayMs) {
        if (birdRespawnTimer) return; // —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω

        birdRespawnTimer = setTimeout(() => {
          birdRespawnTimer = null;

          if (bird) {
            World.remove(world, bird);
            bird = null;
          }

          spawnBird(IMGS, false);
          setBirdIdle();
          birdLaunched = false;

          $("status").textContent = "–ì–æ—Ç–æ–≤–æ";
        }, delayMs);
      }

      function tryBreakSomeJointNear(pair) {
        // –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –ª–æ–º–∞–µ–º –æ–¥–∏–Ω –±–ª–∏–∂–∞–π—à–∏–π –Ω–µ–ø–æ–ª–æ–º–∞–Ω–Ω—ã–π joint
        // (—á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–≤–∞–ª–∏–≤–∞–ª–æ –≤—Å—ë –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ)
        const x = pair.collision.supports && pair.collision.supports[0]
          ? pair.collision.supports[0].x
          : (pair.bodyA.position.x + pair.bodyB.position.x) / 2;

        const y = pair.collision.supports && pair.collision.supports[0]
          ? pair.collision.supports[0].y
          : (pair.bodyA.position.y + pair.bodyB.position.y) / 2;

        let best = null;
        let bestD = Infinity;

        for (const j of structure.joints) {
          if (!j.__breakable || j.__broken) continue;

          // –æ—Ü–µ–Ω–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ joint
          const ax = j.bodyA ? j.bodyA.position.x + (j.pointA ? j.pointA.x : 0) : 0;
          const ay = j.bodyA ? j.bodyA.position.y + (j.pointA ? j.pointA.y : 0) : 0;

          const d = (ax - x) * (ax - x) + (ay - y) * (ay - y);
          if (d < bestD) {
            bestD = d;
            best = j;
          }
        }

        // –ª–æ–º–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–ª–∏–∑–∫–æ
        if (best && bestD < 180 * 180) {
          best.__broken = true;
          World.remove(world, best);

          stats.broken += 1;
          stats.score += 10;
          updateHUD();
          toast("–•—Ä—É—Å—Ç! –ë–∞–ª–∫–∞ –ø–æ—à–ª–∞‚Ä¶", 700);

          // —á—É—Ç—å ‚Äú–æ—Å–ª–∞–±–∏–º‚Äù –±–ª–∏–∂–∞–π—à—É—é –±–∞–ª–∫—É (—á—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç –±—ã–ª –∑–∞–º–µ—Ç–Ω–µ–µ)
          if (best.bodyA && !best.bodyA.isStatic) {
            best.bodyA.frictionAir = Math.min(0.06, (best.bodyA.frictionAir || 0.01) + 0.01);
          }
        }
      }

    })();
  </script>
</body>
</html>
