<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Office Birds ‚Äî Destruction</title>

  <style>
    html, body {
      margin:0; padding:0; width:100%; height:100%;
      overflow:hidden; background:#06121f;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    #wrap { position:fixed; inset:0; }
    canvas { display:block; width:100%; height:100%; touch-action:none; }

    .hud {
      position:fixed; left:16px; top:16px; z-index:10;
      display:flex; gap:12px; align-items:flex-start;
    }
    .panel {
      background:rgba(9,18,28,.55);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      padding:10px 12px;
      color:rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      min-width:270px;
    }
    .panel h1{ font-size:14px; margin:0 0 6px 0; font-weight:900; letter-spacing:.2px; }
    .panel small{ display:block; opacity:.88; font-size:12px; line-height:1.35; }

    .btnbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button{
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.16);
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      user-select:none;
    }
    button:hover{ background:rgba(255,255,255,.16); }
    button.super-on{
      background:rgba(255, 210, 70, .18);
      border-color:rgba(255, 210, 70, .38);
      box-shadow: 0 0 0 2px rgba(255, 210, 70, .14) inset;
    }

    .right{ position:fixed; top:16px; right:16px; z-index:10; width:360px; }
    .kv{ display:grid; grid-template-columns:1fr auto; gap:6px 10px; margin-top:8px; font-size:12px; opacity:.95; }
    .kv div:nth-child(2n){ font-weight:900; }

    .toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      z-index:10; padding:7px 12px; font-size:12px; color:rgba(255,255,255,.94);
      background:rgba(0,0,0,.44); border:1px solid rgba(255,255,255,.12);
      border-radius:999px; backdrop-filter: blur(6px);
      pointer-events:none; opacity:0; transition:opacity .18s ease;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .toast.show{ opacity:1; }

    /* ‚úÖ –û–ì–†–û–ú–ù–ê–Ø SUPER –∫–Ω–æ–ø–∫–∞ —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞ */
    .super-fly {
      position: fixed;
      left: 50%;
      bottom: 26px;
      transform: translateX(-50%);
      z-index: 20;
      display: none;
    }
    .super-fly.show { display:block; }

    .super-fly button{
      font-size: 28px;
      padding: 30px 52px;
      border-radius: 24px;

      border: 3px solid rgba(255,210,70,.65);
      background: rgba(255,210,70,.18);

      box-shadow:
        0 18px 58px rgba(0,0,0,.44),
        0 0 0 4px rgba(255,210,70,.14) inset;

      letter-spacing: .9px;
    }
    .super-fly button:hover{
      background: rgba(255,210,70,.24);
    }
    .super-fly button.super-on{
      background: rgba(255,210,70,.30);
      box-shadow:
        0 18px 65px rgba(0,0,0,.50),
        0 0 0 4px rgba(255,210,70,.18) inset;
    }
    .super-fly .hint{
      text-align:center;
      margin-top:10px;
      font-size:14px;
      color: rgba(255,255,255,.88);
      opacity:.92;
      text-shadow: 0 2px 10px rgba(0,0,0,.55);
      user-select:none;
      pointer-events:none;
    }
  </style>
</head>

<body>
  <div class="hud">
    <div class="panel">
      <h1>Office Birds ‚Äî Destruction</h1>
      <small><b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</b> –∑–∞–∂–º–∏ —á–µ–ª–æ–≤–µ—á–∫–∞ ‚Üí —Ç—è–Ω–∏ –≤ –ª—é–±—É—é —Å—Ç–æ—Ä–æ–Ω—É ‚Üí –æ—Ç–ø—É—Å—Ç–∏ (–ª–µ—Ç–∏—Ç –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é).</small>
      <small><b>SUPER:</b> –æ–≥—Ä–æ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞.</small>
      <div class="kv">
        <div>–°—á—ë—Ç:</div><div id="score">0</div>
        <div>–°–ª–æ–º–∞–Ω–æ:</div><div id="broken">0</div>
        <div>–ü–æ–ø–∞–¥–∞–Ω–∏–π:</div><div id="hits">0</div>
        <div>–ü–æ–±–µ–¥:</div><div id="wins">0</div>
      </div>
    </div>

    <div class="btnbar">
      <button id="resetBtn">Reset</button>
      <button id="debugBtn">DEBUG</button>
      <!-- –º–∞–ª–µ–Ω—å–∫—É—é –∫–Ω–æ–ø–∫—É —Å–∫—Ä—ã–≤–∞–µ–º (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) -->
      <button id="superBtn" style="display:none">SUPER</button>
    </div>
  </div>

  <div class="right">
    <div class="panel">
      <h1>–¶–µ–ª—å</h1>
      <small>–í—ã–±–µ–π –≤—Å–µ—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ üèÜ</small>
      <small>–°–∏–ª—å–Ω—ã–π —É–¥–∞—Ä ‚Üí —à–µ–π–∫ –∫–∞–º–µ—Ä—ã. SUPER ‚Üí –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ + ¬´–†–∞—Å–∫–∞—á–∞–µ–º—Å—è!!!¬ª</small>
      <div class="kv">
        <div>–°—Ç–∞—Ç—É—Å:</div><div id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        <div>SUPER:</div><div id="superState">OFF</div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ –ë–æ–ª—å—à–∞—è —Å—É–ø–µ—Ä-–∫–Ω–æ–ø–∫–∞ –≤ –ø–æ–ª—ë—Ç–µ -->
  <div class="super-fly" id="superFlyWrap">
    <button id="superFlyBtn">SUPER ‚ö°</button>
    <div class="hint">–ù–∞–∂–º–∏ –æ–¥–∏–Ω —Ä–∞–∑, –ø–æ–∫–∞ –ª–µ—Ç–∏—à—å</div>
  </div>

  <div id="wrap"><canvas id="c"></canvas></div>
  <div id="toast" class="toast">‚Ä¶</div>

  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

  <script>
  (function(){
    "use strict";

    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    function toast(msg, ms=1400){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), ms);
    }

    function loadImage(src){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = ()=>resolve(img);
        img.onerror = ()=>reject(new Error("–ù–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –∫–∞—Ä—Ç–∏–Ω–∫–∞: " + src));
        img.src = src + (src.includes("?") ? "&" : "?") + "v=" + Date.now();
      });
    }

    // ‚úÖ –ø—É—Ç–∏ –∞—Å—Å–µ—Ç–æ–≤
    const ASSETS = {
      bg: "assets/bg_office.png",
      beam: "assets/office/beam.png",
      pillar: "assets/office/pillar.png",
      manager: "assets/office/manager.png",
      humanIdle: "assets/player/human_idle.png",
      humanFly: "assets/player/human_fly.png",
      chair: "assets/player/chair.png",

      // SUPER skin (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç—É–ª; –º–æ–∂–µ—à—å –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ human_on_chair.png)
      superSkin: "assets/player/chair.png"
    };

    const {
      Engine, Render, Runner, World, Bodies, Body,
      Constraint, Events, Composite, Vector
    } = Matter;

    let engine, world, render, runner, ground;

    let bird = null;
    let birdLaunched = false;
    let birdRespawnTimer = null;

    let slingshot = null;
    let slingAnchor = null;

    let draggingBird = false;
    let canLaunch = true;
    let dragView = null;

    let DEBUG = false;

    // –î–µ–∫–æ—Ä-—Å—Ç—É–ª: –ù–ï —Ñ–∏–∑–∏–∫–∞, —Ä–∏—Å—É–µ–º –ø–æ–≤–µ—Ä—Ö
    let chairDecal = null;

    // SUPER
    let superActive = false;
    let superPulseT = 0;
    let superBannerFrames = 0;
    let superDim = 0;
    let superAuraPulse = 0;

    // –∫–∞—á–∞–Ω–∏–µ
    let birdSwingBaseAngle = 0;

    // –∫–∞–º–µ—Ä–∞-—à–µ–π–∫
    let shakeTime = 0;
    let shakeMag = 0;

    // debris (–æ—Å–∫–æ–ª–∫–∏)
    const debris = []; // {body, ttl, stillFrames}

    // level
    const structure = { pillars: [], beams: [], managers: [], activated: false };
    const stats = { score:0, broken:0, hits:0, wins:0 };

    const AUTO_RESPAWN_MS = 9000;

    // ‚úÖ –ª–æ–º–∞—é—â–∞—è—Å—è –º–µ—Ö–∞–Ω–∏–∫–∞ (–±—ã—Å—Ç—Ä–æ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ)
    const DMG = {
      energyScale: 0.22,
      minEnergy: 1.6,

      hpBeam: 3.2,
      hpPillar: 4.2,
      hpManager: 2.6,

      // —Å–∏–ª—å–Ω—ã–π —É–¥–∞—Ä = —Å—Ä–∞–∑—É –≤ —â–µ–ø–∫–∏
      instaShatterEnergy: 22,

      shakeEnergyThreshold: 16,
      shakeMax: 20,

      superMultiplier: 2.5,

      // SUPER aura
      superAuraRadius: 210,
      superAuraEnergyPerTick: 10.0,
      superAuraTickEvery: 6
    };

    const DEBRIS = {
      ttlMs: 5200,
      minSpeedToCountStill: 0.18,
      stillFramesToVanish: 45,
      airFriction: 0.020,
    };

    const SPR = {
      pillarH: 310,
      beamW: 420,

      birdRadius: 56,
      birdWIdle: 165,
      birdWFly: 135,
      birdWSuper: 175,

      managerW: 86,
      chairW: 120
    };

    const LEVEL = {
      floorHeight: 95,
      birdStartX: 210,
      birdStartYOffset: 190,
      houses: [
        { x: 0.56, w: 420, managers: 3 },
        { x: 0.72, w: 420, managers: 3 },
        { x: 0.88, w: 420, managers: 2 },
      ]
    };

    const camera = {
      cx: 0, cy: 0,
      tx: 0, ty: 0,
      zoom: 1.0,
      tzoom: 1.0,
      worldMinX: -200,
      worldMaxX: 5200,
      worldMinY: -3200,
      worldMaxY: 2600,
      smoothing: 0.12
    };

    function lerp(a,b,t){ return a + (b-a)*t; }
    function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

    // ‚úÖ —Ä–æ–≥–∞—Ç–∫–∞
    const SLING = {
      pullMax: 380,
      launchK: 0.145
    };

    // ‚úÖ –±–æ–ª—å—à–∞—è –∫–Ω–æ–ø–∫–∞ —Å—É–ø–µ—Ä
    const superFlyWrap = $("superFlyWrap");
    const superFlyBtn  = $("superFlyBtn");

    function refreshSuperButtonVisibility(){
      // –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –ø–æ–ª—ë—Ç–µ –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
      const shouldShow = !!(bird && birdLaunched && !superActive);
      superFlyWrap.classList.toggle("show", shouldShow);
      superFlyBtn.classList.toggle("super-on", superActive);
    }

    function setSuperActive(next){
      superActive = next;

      if (superActive){
        superPulseT = 0;
        superBannerFrames = 140;
        superDim = Math.max(superDim, 0.18);

        // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–π —É–≥–æ–ª –¥–ª—è –∫–∞—á–∞–Ω–∏—è
        birdSwingBaseAngle = (bird && typeof bird.angle === "number") ? bird.angle : 0;

        toast("SUPER ON ‚ö°", 900);

        // –µ—Å–ª–∏ —É–∂–µ –≤ –ø–æ–ª—ë—Ç–µ ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Å—É–ø–µ—Ä-—Å–∫–∏–Ω
        if (bird && birdLaunched) setBirdSuper();
      } else {
        toast("SUPER OFF", 700);
      }

      $("superState").textContent = superActive ? "ON" : "OFF";
      refreshSuperButtonVisibility();
    }

    superFlyBtn.addEventListener("click", ()=>{
      if (!bird || !birdLaunched || superActive) return;
      setSuperActive(true);
    });

    $("status").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤‚Ä¶";

    Promise.all([
      loadImage(ASSETS.bg),
      loadImage(ASSETS.beam),
      loadImage(ASSETS.pillar),
      loadImage(ASSETS.manager),
      loadImage(ASSETS.humanIdle),
      loadImage(ASSETS.humanFly),
      loadImage(ASSETS.chair),
      loadImage(ASSETS.superSkin)
    ]).then(([imgBg, imgBeam, imgPillar, imgManager, imgIdle, imgFly, imgChair, imgSuper])=>{
      start({imgBg, imgBeam, imgPillar, imgManager, imgIdle, imgFly, imgChair, imgSuper});
    }).catch((e)=>{
      console.error(e);
      $("status").textContent = "–û—à–∏–±–∫–∞ PNG";
      toast("PNG –æ—à–∏–±–∫–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å assets/‚Ä¶", 2500);
    });

    function updateHUD(){
      $("score").textContent  = String(stats.score);
      $("broken").textContent = String(stats.broken);
      $("hits").textContent   = String(stats.hits);
      $("wins").textContent   = String(stats.wins);
      $("superState").textContent = superActive ? "ON" : "OFF";
      refreshSuperButtonVisibility();
    }

    function start(IMGS){
      $("status").textContent = "–ó–∞–ø—É—Å–∫‚Ä¶";

      const canvas = $("c");
      const wrap = $("wrap");

      engine = Engine.create();
      world = engine.world;
      world.gravity.y = 1.05;

      render = Render.create({
        element: wrap,
        canvas,
        engine,
        options: {
          width: window.innerWidth,
          height: window.innerHeight,
          wireframes: false,
          background: ASSETS.bg,
          pixelRatio: window.devicePixelRatio || 1,
          hasBounds: true
        }
      });

      runner = Runner.create();

      ground = Bodies.rectangle(
        2600,
        window.innerHeight - LEVEL.floorHeight/2,
        9000,
        LEVEL.floorHeight,
        {
          isStatic: true,
          friction: 1.0,
          restitution: 0.0,
          render: DEBUG ? { fillStyle:"rgba(255,255,255,0.10)" } : { fillStyle:"rgba(0,0,0,0)" }
        }
      );
      World.add(world, ground);

      buildLevel(IMGS);
      spawnBird(IMGS);
      setupSlingshot();
      setupCameraInitial();
      bindPointerControls(IMGS);
      bindPhysics(IMGS);

      Events.on(render, "afterRender", ()=>{
        if (chairDecal) drawChairDecal(IMGS);
        drawSuperOverlay();
      });

      Render.run(render);
      Runner.run(runner, engine);

      $("resetBtn").addEventListener("click", ()=>resetAll(IMGS));
      $("debugBtn").addEventListener("click", ()=>{
        DEBUG = !DEBUG;
        toast(DEBUG ? "DEBUG: ON" : "DEBUG: OFF", 900);
        resetAll(IMGS);
      });

      window.addEventListener("resize", ()=>onResize(IMGS));

      $("status").textContent = "–ì–æ—Ç–æ–≤–æ";
      updateHUD();
    }

    function onResize(IMGS){
      render.canvas.width  = window.innerWidth;
      render.canvas.height = window.innerHeight;
      render.options.width  = window.innerWidth;
      render.options.height = window.innerHeight;
      resetAll(IMGS);
    }

    function resetAll(IMGS){
      if (birdRespawnTimer){ clearTimeout(birdRespawnTimer); birdRespawnTimer = null; }

      Composite.clear(world, false);
      World.add(world, ground);

      stats.score = 0; stats.broken = 0; stats.hits = 0; stats.wins = 0;
      structure.pillars = []; structure.beams = []; structure.managers = []; structure.activated = false;

      debris.length = 0;

      bird = null;
      slingshot = null;
      slingAnchor = null;

      draggingBird = false;
      canLaunch = true;
      birdLaunched = false;
      dragView = null;

      chairDecal = null;

      superActive = false;
      superPulseT = 0;
      superBannerFrames = 0;
      superDim = 0;
      superAuraPulse = 0;
      birdSwingBaseAngle = 0;

      shakeTime = 0;
      shakeMag = 0;

      buildLevel(IMGS);
      spawnBird(IMGS);
      setupSlingshot();
      setupCameraInitial();

      refreshSuperButtonVisibility();
      $("status").textContent = "–ì–æ—Ç–æ–≤–æ";
      updateHUD();
    }

    function makeBreakable(body, type, hp){
      body.__type = type;
      body.__hp = hp;
      body.__broken = false;
      return body;
    }

    function buildLevel(IMGS){
      const baseY = window.innerHeight - LEVEL.floorHeight;

      structure.pillars = [];
      structure.beams = [];
      structure.managers = [];

      for (let hi=0; hi<LEVEL.houses.length; hi++){
        const H = LEVEL.houses[hi];
        const cx = Math.round(window.innerWidth * H.x);
        const w = H.w;

        const leftX  = cx - Math.round(w/2);
        const rightX = cx + Math.round(w/2);

        const pillarScale = SPR.pillarH / IMGS.imgPillar.height;
        const beamScale   = SPR.beamW   / IMGS.imgBeam.width;

        const pillarH = IMGS.imgPillar.height * pillarScale;
        const pillarW = IMGS.imgPillar.width  * pillarScale;

        const pLeft = makeBreakable(
          Bodies.rectangle(leftX, baseY - pillarH/2, pillarW, pillarH, {
            isStatic: true,
            render: DEBUG
              ? { fillStyle:"rgba(0,210,255,0.20)", strokeStyle:"rgba(110,240,255,0.9)", lineWidth:2 }
              : { sprite:{ texture: ASSETS.pillar, xScale: pillarScale, yScale: pillarScale } }
          }),
          "pillar",
          DMG.hpPillar
        );

        const pRight = makeBreakable(
          Bodies.rectangle(rightX, baseY - pillarH/2, pillarW, pillarH, {
            isStatic: true,
            render: DEBUG
              ? { fillStyle:"rgba(0,210,255,0.20)", strokeStyle:"rgba(110,240,255,0.9)", lineWidth:2 }
              : { sprite:{ texture: ASSETS.pillar, xScale: pillarScale, yScale: pillarScale } }
          }),
          "pillar",
          DMG.hpPillar
        );

        const beamW = IMGS.imgBeam.width  * beamScale;
        const beamH = IMGS.imgBeam.height * beamScale;

        const yBot = baseY - 46;
        const yMid = baseY - 172;
        const yTop = baseY - 298;

        function makeBeam(x,y){
          const b = makeBreakable(
            Bodies.rectangle(x, y, beamW, beamH, {
              isStatic: true,
              friction: 0.95,
              restitution: 0.02,
              density: 0.0022,
              chamfer: { radius: 4 },
              render: DEBUG
                ? { fillStyle:"rgba(255,120,0,0.25)", strokeStyle:"rgba(255,170,90,0.9)", lineWidth:2 }
                : { sprite:{ texture: ASSETS.beam, xScale: beamScale, yScale: beamScale } }
            }),
            "beam",
            DMG.hpBeam
          );
          b.__beamScale = beamScale;
          return b;
        }

        const bTop = makeBeam(cx, yTop);
        const bMid = makeBeam(cx, yMid);
        const bBot = makeBeam(cx, yBot);

        const mScale = SPR.managerW / IMGS.imgManager.width;
        const mW = IMGS.imgManager.width * mScale;
        const mH = IMGS.imgManager.height * mScale;

        const managers = [];
        for (let i=0; i<H.managers; i++){
          const t = (i+1)/(H.managers+1);
          const x = cx - w*0.24 + t*(w*0.48);
          const y = yMid - beamH/2 - mH/2 + 10;

          const m = makeBreakable(
            Bodies.rectangle(x, y, mW, mH, {
              isStatic: true,
              friction: 0.85,
              restitution: 0.02,
              density: 0.002,
              render: DEBUG
                ? { fillStyle:"rgba(255,255,255,0.16)", strokeStyle:"rgba(255,255,255,0.9)", lineWidth:2 }
                : { sprite:{ texture: ASSETS.manager, xScale: mScale, yScale: mScale } }
            }),
            "manager",
            DMG.hpManager
          );

          m.__alive = true;
          m.__mScale = mScale;
          managers.push(m);
        }

        structure.pillars.push(pLeft, pRight);
        structure.beams.push(bTop, bMid, bBot);
        structure.managers.push(...managers);

        World.add(world, [pLeft, pRight, bTop, bMid, bBot, ...managers]);
      }
    }

    function activateStructure(){
      if (structure.activated) return;
      structure.activated = true;

      for (const b of structure.beams){ Body.setStatic(b, false); b.frictionAir = 0.010; }
      for (const p of structure.pillars){ Body.setStatic(p, false); p.frictionAir = 0.012; }
      for (const m of structure.managers){ Body.setStatic(m, false); m.frictionAir = 0.020; }
    }

    function spawnBird(IMGS){
      const baseY = window.innerHeight - LEVEL.floorHeight;
      const start = { x: LEVEL.birdStartX, y: baseY - LEVEL.birdStartYOffset };

      const idleScale = SPR.birdWIdle / IMGS.imgIdle.width;
      const flyScale  = SPR.birdWFly  / IMGS.imgFly.width;
      const superScale = SPR.birdWSuper / IMGS.imgSuper.width;

      bird = Bodies.circle(start.x, start.y, SPR.birdRadius, {
        restitution: 0.18,
        friction: 0.95,
        frictionAir: 0.012,
        density: 0.0048,
        render: DEBUG
          ? { fillStyle:"rgba(255,0,0,0.22)", strokeStyle:"rgba(255,0,0,0.9)", lineWidth:2 }
          : { sprite:{ texture: ASSETS.humanIdle, xScale: idleScale, yScale: idleScale } }
      });

      bird.__start = start;

      bird.__idleTexture = ASSETS.humanIdle;
      bird.__idleScale = idleScale;

      bird.__flyTexture = ASSETS.humanFly;
      bird.__flyScale = flyScale;

      bird.__superTexture = ASSETS.superSkin;
      bird.__superScale = superScale;

      birdLaunched = false;
      World.add(world, bird);

      refreshSuperButtonVisibility();
    }

    function setBirdIdle(){
      if (!bird || DEBUG) return;
      bird.render.sprite.texture = bird.__idleTexture;
      bird.render.sprite.xScale = bird.__idleScale;
      bird.render.sprite.yScale = bird.__idleScale;
    }

    function setBirdFly(){
      if (!bird || DEBUG) return;
      bird.render.sprite.texture = bird.__flyTexture;
      bird.render.sprite.xScale = bird.__flyScale;
      bird.render.sprite.yScale = bird.__flyScale;
    }

    function setBirdSuper(){
      if (!bird || DEBUG) return;
      bird.render.sprite.texture = bird.__superTexture;
      bird.render.sprite.xScale = bird.__superScale;
      bird.render.sprite.yScale = bird.__superScale;
    }

    function setupSlingshot(){
      const start = bird.__start;
      slingAnchor = { x: start.x, y: start.y };

      slingshot = Constraint.create({
        pointA: { x: slingAnchor.x, y: slingAnchor.y },
        bodyB: bird,
        pointB: { x: 0, y: 0 },
        stiffness: 0.035,
        damping: 0.06,
        length: 0,
        render: { visible: DEBUG }
      });

      World.add(world, slingshot);
    }

    function detachSlingshot(){
      if (!slingshot) return;
      World.remove(world, slingshot);
      slingshot = null;
    }

    // ‚úÖ –î–ï–ö–û–†-–°–¢–£–õ (–ù–ï —Ñ–∏–∑–∏–∫–∞)
    function spawnChairDecal(IMGS, atPos){
      const chairScale = SPR.chairW / IMGS.imgChair.width;
      chairDecal = {
        x: atPos.x,
        y: atPos.y + 64,
        w: IMGS.imgChair.width * chairScale,
        h: IMGS.imgChair.height * chairScale
      };
    }
    function clearChairDecal(){ chairDecal = null; }

    function scheduleBirdRespawn(IMGS, delayMs){
      if (birdRespawnTimer) return;

      birdRespawnTimer = setTimeout(()=>{
        birdRespawnTimer = null;

        if (bird){ World.remove(world, bird); bird = null; }
        if (slingshot){ World.remove(world, slingshot); slingshot = null; }

        clearChairDecal();

        superActive = false;
        superPulseT = 0;
        superBannerFrames = 0;
        superDim = 0;
        superAuraPulse = 0;
        birdSwingBaseAngle = 0;

        spawnBird(IMGS);
        setupSlingshot();
        setBirdIdle();

        birdLaunched = false;
        draggingBird = false;
        canLaunch = true;
        dragView = null;

        refreshSuperButtonVisibility();
        $("status").textContent = "–ì–æ—Ç–æ–≤–æ";
        updateHUD();
      }, delayMs);
    }

    // ====== SHATTER / DEBRIS ======

    function addDebrisBody(body){
      body.__debris = true;
      body.frictionAir = DEBRIS.airFriction;
      debris.push({ body, ttl: Date.now() + DEBRIS.ttlMs, stillFrames: 0 });
      World.add(world, body);
    }

    function shatterRect(body, tex, scaleX, scaleY, piecesX, piecesY){
      if (!body || body.__broken) return;
      body.__broken = true;

      const pos = body.position;
      const angle = body.angle;

      const w = body.bounds.max.x - body.bounds.min.x;
      const h = body.bounds.max.y - body.bounds.min.y;

      const px = clamp(piecesX|0, 2, 8);
      const py = clamp(piecesY|0, 2, 8);

      const cw = w / px;
      const ch = h / py;

      const right = Vector.rotate({x:1,y:0}, angle);
      const down  = Vector.rotate({x:0,y:1}, angle);

      World.remove(world, body);

      // remove from arrays (—á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ—Ç–æ–º)
      const arr = (body.__type === "beam") ? structure.beams
               : (body.__type === "pillar") ? structure.pillars
               : (body.__type === "manager") ? structure.managers
               : null;
      if (arr){
        const idx = arr.indexOf(body);
        if (idx >= 0) arr.splice(idx, 1);
      }

      for (let iy=0; iy<py; iy++){
        for (let ix=0; ix<px; ix++){
          const localX = (ix + 0.5) * cw - w/2;
          const localY = (iy + 0.5) * ch - h/2;

          const wp = Vector.add(pos, Vector.add(Vector.mult(right, localX), Vector.mult(down, localY)));

          const piece = Bodies.rectangle(
            wp.x, wp.y,
            Math.max(10, cw*0.92),
            Math.max(10, ch*0.92),
            {
              isStatic: false,
              friction: 0.95,
              restitution: 0.05,
              density: 0.0022,
              chamfer: { radius: 2 },
              render: DEBUG
                ? { fillStyle:"rgba(255,255,255,0.12)", strokeStyle:"rgba(255,255,255,0.5)", lineWidth:1 }
                : { sprite:{ texture: tex, xScale: scaleX, yScale: scaleY } }
            }
          );

          Body.setAngle(piece, angle);
          Body.setVelocity(piece, {
            x: body.velocity.x + (Math.random()-0.5)*2.4,
            y: body.velocity.y + (Math.random()-0.5)*2.4
          });
          Body.setAngularVelocity(piece, body.angularVelocity + (Math.random()-0.5)*0.40);

          addDebrisBody(piece);
        }
      }

      stats.broken += 1;
      stats.score += 18;
      updateHUD();
    }

    // ====== WIN ======
    function killManager(m, IMGS){
      if (!m || !m.__alive) return;
      m.__alive = false;

      const s = m.__mScale || 1;
      shatterRect(m, ASSETS.manager, s, s, 4, 4);

      stats.hits += 1;
      stats.score += 30;
      updateHUD();
      toast("–ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞–∑–ª–µ—Ç–µ–ª—Å—è üòµ", 850);
      checkWin();
    }

    function checkWin(){
      const alive = structure.managers.some(m => m.__alive);
      if (!alive){
        stats.wins += 1;
        stats.score += 140;
        updateHUD();
        toast("–ü–û–ë–ï–î–ê! –í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –≤—ã–±–∏—Ç—ã üèÜ", 1600);
      }
    }

    // ====== CAMERA ======
    function setupCameraInitial(){
      const baseY = window.innerHeight - LEVEL.floorHeight;
      camera.cx = camera.tx = 900;
      camera.cy = camera.ty = baseY - 260;
      camera.zoom = camera.tzoom = 0.88;
      applyCamera(true);
    }

    function triggerShake(energy){
      const over = energy - DMG.shakeEnergyThreshold;
      const strength = clamp(over * 1.7, 7, DMG.shakeMax);
      shakeMag = Math.max(shakeMag, strength);
      shakeTime = Math.max(shakeTime, 18);
    }

    function applyCamera(force=false){
      camera.cx = force ? camera.tx : lerp(camera.cx, camera.tx, camera.smoothing);
      camera.cy = force ? camera.ty : lerp(camera.cy, camera.ty, camera.smoothing);
      camera.zoom = force ? camera.tzoom : lerp(camera.zoom, camera.tzoom, camera.smoothing);

      let sx = 0, sy = 0;
      if (shakeTime > 0){
        const amp = shakeMag * (shakeTime / 18);
        sx = (Math.random()*2 - 1) * amp;
        sy = (Math.random()*2 - 1) * amp;
      }

      const vw = window.innerWidth / camera.zoom;
      const vh = window.innerHeight / camera.zoom;

      let minX = (camera.cx + sx) - vw/2;
      let minY = (camera.cy + sy) - vh/2;
      let maxX = minX + vw;
      let maxY = minY + vh;

      // clamp to world
      const wWorld = camera.worldMaxX - camera.worldMinX;
      const hWorld = camera.worldMaxY - camera.worldMinY;

      if (vw < wWorld){
        minX = clamp(minX, camera.worldMinX, camera.worldMaxX - vw);
        maxX = minX + vw;
      } else {
        minX = camera.worldMinX; maxX = camera.worldMaxX;
      }

      if (vh < hWorld){
        minY = clamp(minY, camera.worldMinY, camera.worldMaxY - vh);
        maxY = minY + vh;
      } else {
        minY = camera.worldMinY; maxY = camera.worldMaxY;
      }

      render.bounds.min.x = minX;
      render.bounds.min.y = minY;
      render.bounds.max.x = maxX;
      render.bounds.max.y = maxY;

      Render.lookAt(render, { min: render.bounds.min, max: render.bounds.max });
    }

    // ====== INPUT ======
    function pointerToWorld(e){
      const rect = render.canvas.getBoundingClientRect();
      const sx = (e.clientX - rect.left) / rect.width;
      const sy = (e.clientY - rect.top) / rect.height;
      const b = (draggingBird && dragView) ? dragView : render.bounds;
      return {
        x: b.min.x + sx * (b.max.x - b.min.x),
        y: b.min.y + sy * (b.max.y - b.min.y)
      };
    }

    function bindPointerControls(IMGS){
      const canvas = render.canvas;

      canvas.addEventListener("pointerdown", (e)=>{
        if (!bird || birdLaunched || !canLaunch) return;

        const p = pointerToWorld(e);
        const dx = p.x - bird.position.x;
        const dy = p.y - bird.position.y;
        const dist = Math.hypot(dx, dy);

        if (dist <= SPR.birdRadius * 1.25){
          canvas.setPointerCapture(e.pointerId);
          draggingBird = true;

          // freeze view while dragging
          dragView = {
            min: { x: render.bounds.min.x, y: render.bounds.min.y },
            max: { x: render.bounds.max.x, y: render.bounds.max.y }
          };

          Body.setStatic(bird, true);
          $("status").textContent = "–¢—è–Ω–∏‚Ä¶";
        }
      });

      canvas.addEventListener("pointermove", (e)=>{
        if (!bird || !draggingBird || birdLaunched) return;

        const start = bird.__start;
        const p = pointerToWorld(e);

        let dx = p.x - start.x;
        let dy = p.y - start.y;

        const dist = Math.hypot(dx, dy) || 1;
        const k = Math.min(1, SLING.pullMax / dist);

        Body.setPosition(bird, { x: start.x + dx * k, y: start.y + dy * k });
        Body.setVelocity(bird, { x: 0, y: 0 });
        Body.setAngularVelocity(bird, 0);
        bird.isSleeping = false;
      });

      canvas.addEventListener("pointerup", ()=>{
        if (!bird || !draggingBird || birdLaunched) {
          draggingBird = false; dragView = null; return;
        }

        draggingBird = false;
        dragView = null;
        if (!canLaunch) return;

        activateStructure();

        // –Ω–∞ –≤—ã—Å—Ç—Ä–µ–ª–µ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—ë—Ç
        setBirdFly();

        // –¥–µ–∫–æ—Ä-—Å—Ç—É–ª –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã—Å—Ç—Ä–µ–ª–∞ –∏ –ù–ï –º–µ—à–∞–µ—Ç
        spawnChairDecal(IMGS, bird.__start);

        detachSlingshot();
        Body.setStatic(bird, false);
        bird.isSleeping = false;

        // –≤–µ–∫—Ç–æ—Ä –Ω–∞—Ç—è–∂–µ–Ω–∏—è
        const pull = Vector.sub(bird.__start, bird.position);
        const d = Math.min(Vector.magnitude(pull), SLING.pullMax);

        if (d > 8){
          const dir = Vector.normalise(pull);
          const vel = Vector.mult(dir, d * SLING.launchK);

          Body.setVelocity(bird, { x: 0, y: 0 });
          Body.setAngularVelocity(bird, 0);
          Body.setVelocity(bird, vel);
          bird.frictionAir = 0.005;

          birdSwingBaseAngle = 0;
        }

        birdLaunched = true;
        canLaunch = false;

        stats.score += 1;
        updateHUD();
        $("status").textContent = "–ü–æ–ª–µ—Ç–µ–ª!";

        // –ø–æ–∫–∞–∑–∞—Ç—å –æ–≥—Ä–æ–º–Ω—É—é –∫–Ω–æ–ø–∫—É SUPER
        refreshSuperButtonVisibility();

        scheduleBirdRespawn(IMGS, AUTO_RESPAWN_MS);
      });

      canvas.addEventListener("pointercancel", ()=>{
        draggingBird = false;
        dragView = null;
        if (bird) Body.setStatic(bird, false);
      });
    }

    // ====== DAMAGE / COLLISIONS ======

    // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è —É–¥–∞—Ä–∞ –ø–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
    function impactEnergy(bodyA, bodyB){
      const rv = Vector.sub(bodyA.velocity, bodyB.velocity);
      const rel = Vector.magnitude(rv);

      const m = (bird && (bodyA === bird || bodyB === bird))
        ? bird.mass
        : Math.min(bodyA.mass || 1, bodyB.mass || 1);

      return 0.5 * m * rel * rel;
    }

    function forceShatter(body, IMGS){
      if (!body || body.__broken) return;
      body.__broken = true;

      if (body.__type === "beam"){
        const beamScale = body.__beamScale || (SPR.beamW / (IMGS.imgBeam.width || 1));
        shatterRect(body, ASSETS.beam, beamScale, beamScale, 6, 2);
        return;
      }
      if (body.__type === "pillar"){
        const pillarScale = SPR.pillarH / IMGS.imgPillar.height;
        shatterRect(body, ASSETS.pillar, pillarScale, pillarScale, 4, 6);
        return;
      }
      if (body.__type === "manager"){
        killManager(body, IMGS);
        return;
      }
    }

    function applyDamageTo(body, energy, IMGS){
      if (!body || body.__broken) return;
      if (typeof body.__hp !== "number") return;

      const mult = superActive ? DMG.superMultiplier : 1.0;
      const e = energy * mult;

      if (e >= DMG.instaShatterEnergy){
        forceShatter(body, IMGS);
        triggerShake(e);
        return;
      }

      if (e < DMG.minEnergy) return;

      body.__hp -= (e * DMG.energyScale);

      if (body.__hp <= 0){
        forceShatter(body, IMGS);
        if (e >= DMG.shakeEnergyThreshold) triggerShake(e);
      }
    }

    function bindPhysics(IMGS){
      Events.on(engine, "collisionStart", (event)=>{
        if (!structure.activated) return;

        for (const pair of event.pairs){
          const a = pair.bodyA, b = pair.bodyB;
          const energy = impactEnergy(a, b);

          if (energy >= DMG.shakeEnergyThreshold) triggerShake(energy);

          // bird hits
          if (bird && (a === bird || b === bird)){
            const other = (a === bird) ? b : a;
            applyDamageTo(other, energy, IMGS);
          }

          // chain damage
          if (energy >= DMG.minEnergy){
            applyDamageTo(a, energy * 0.85, IMGS);
            applyDamageTo(b, energy * 0.85, IMGS);
          }
        }
      });

      Events.on(engine, "beforeUpdate", ()=>{
        const baseY = window.innerHeight - LEVEL.floorHeight;

        // debris cleanup
        for (let i = debris.length - 1; i >= 0; i--){
          const d = debris[i];
          const body = d.body;
          if (!body){ debris.splice(i,1); continue; }

          const sp = Vector.magnitude(body.velocity);
          d.stillFrames = (sp < DEBRIS.minSpeedToCountStill) ? (d.stillFrames + 1) : 0;

          if (Date.now() > d.ttl || d.stillFrames >= DEBRIS.stillFramesToVanish){
            World.remove(world, body);
            debris.splice(i,1);
          }
        }

        // shake decay
        if (shakeTime > 0){
          shakeTime -= 1;
          shakeMag = lerp(shakeMag, 0, 0.22);
        }

        // overlay fade/pulse
        if (superActive){
          superDim = lerp(superDim, 0.18, 0.08);
          superAuraPulse = lerp(superAuraPulse, 1.0, 0.10);
        } else {
          superDim = lerp(superDim, 0.0, 0.08);
          superAuraPulse = lerp(superAuraPulse, 0.0, 0.12);
        }
        if (superBannerFrames > 0) superBannerFrames -= 1;

        // ‚úÖ SUPER: –∫–∞—á–∞–Ω–∏–µ + –∞—É—Ä–∞-—É—Ä–æ–Ω
        if (superActive && bird && birdLaunched){
          superPulseT += 1;

          // —Å—É–ø–µ—Ä-—Å–∫–∏–Ω
          setBirdSuper();

          // –∫–∞—á–∞–Ω–∏–µ —Ç–µ–ª–∞ (—Å–∞–º bird –≤—Ä–∞—â–∞–µ—Ç—Å—è)
          const swing = Math.sin(superPulseT * 0.22) * 0.45;
          const targetAngle = birdSwingBaseAngle + swing;
          Body.setAngularVelocity(bird, 0);
          Body.setAngle(bird, targetAngle);

          // –∞—É—Ä–∞-—É—Ä–æ–Ω —Ä–∞–∑ –≤ N –∫–∞–¥—Ä–æ–≤
          if ((superPulseT % DMG.superAuraTickEvery) === 0){
            const bodies = Composite.allBodies(world);
            const r = DMG.superAuraRadius;
            const r2 = r*r;

            for (const obj of bodies){
              if (!obj || obj === bird) continue;
              if (obj.__debris) continue;

              const dx = obj.position.x - bird.position.x;
              const dy = obj.position.y - bird.position.y;
              const dist2 = dx*dx + dy*dy;
              if (dist2 > r2) continue;

              const t = 1 - (Math.sqrt(dist2) / r);
              const bonusEnergy = DMG.superAuraEnergyPerTick * (0.35 + 0.65*t);

              applyDamageTo(obj, bonusEnergy, IMGS);

              if (!obj.isStatic){
                const dir = Vector.normalise({x:dx, y:dy});
                Body.applyForce(obj, obj.position, { x: dir.x * 0.014 * t, y: dir.y * 0.014 * t });
              }
            }
          }
        }

        // freeze camera during drag
        if (draggingBird && !birdLaunched){
          camera.tx = camera.cx;
          camera.ty = camera.cy;
          camera.tzoom = camera.zoom;
          applyCamera(false);
          return;
        }

        // camera follow
        if (bird && birdLaunched){
          camera.tx = bird.position.x + 240;
          camera.ty = bird.position.y - 120;
          camera.tzoom = 1.10;
        } else {
          camera.tx = 900;
          camera.ty = baseY - 260;
          camera.tzoom = 0.88;
        }

        applyCamera(false);
        refreshSuperButtonVisibility();
      });
    }

    // ====== DRAW DECAL + SUPER OVERLAY ======

    function worldToScreen(x, y){
      const b = render.bounds;
      return {
        x: (x - b.min.x) / (b.max.x - b.min.x) * render.canvas.width,
        y: (y - b.min.y) / (b.max.y - b.min.y) * render.canvas.height
      };
    }

    function drawChairDecal(IMGS){
      if (!chairDecal) return;

      const ctx = render.context;
      const img = IMGS.imgChair;
      const b = render.bounds;

      if (chairDecal.x < b.min.x - 500 || chairDecal.x > b.max.x + 500) return;

      const p = worldToScreen(chairDecal.x, chairDecal.y);

      const vw = (b.max.x - b.min.x);
      const vh = (b.max.y - b.min.y);

      const sw = chairDecal.w / vw * render.canvas.width;
      const sh = chairDecal.h / vh * render.canvas.height;

      ctx.save();
      ctx.globalAlpha = 1.0;
      ctx.drawImage(img, p.x - sw/2, p.y - sh/2, sw, sh);
      ctx.restore();
    }

    function drawSuperOverlay(){
      const ctx = render.context;
      const W = render.canvas.width;
      const H = render.canvas.height;

      if (superDim > 0.004){
        ctx.save();
        ctx.globalAlpha = clamp(superDim, 0, 0.35);
        ctx.fillStyle = "rgba(0,0,0,1)";
        ctx.fillRect(0,0,W,H);

        const pulse = 0.12 + Math.sin((superPulseT||0)*0.10)*0.05;
        ctx.globalAlpha = clamp(superAuraPulse * pulse, 0, 0.22);
        const grd = ctx.createRadialGradient(W*0.5, H*0.45, 40, W*0.5, H*0.45, Math.min(W,H)*0.55);
        grd.addColorStop(0, "rgba(255,210,70,0.55)");
        grd.addColorStop(1, "rgba(255,210,70,0.0)");
        ctx.fillStyle = grd;
        ctx.fillRect(0,0,W,H);
        ctx.restore();
      }

      if (superBannerFrames > 0){
        const t = superBannerFrames / 140;
        const alpha = clamp(0.15 + t, 0, 1);
        const scale = 1.0 + (1 - t)*0.08;

        ctx.save();
        ctx.translate(W*0.5, H*0.22);
        ctx.scale(scale, scale);

        ctx.globalAlpha = alpha;
        ctx.font = "900 66px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        ctx.lineWidth = 10;
        ctx.strokeStyle = "rgba(0,0,0,0.55)";
        ctx.strokeText("–†–∞—Å–∫–∞—á–∞–µ–º—Å—è!!!", 0, 0);

        ctx.shadowColor = "rgba(255,210,70,0.95)";
        ctx.shadowBlur = 22;

        ctx.fillStyle = "rgba(255,235,160,0.98)";
        ctx.fillText("–†–∞—Å–∫–∞—á–∞–µ–º—Å—è!!!", 0, 0);

        ctx.restore();
      }
    }

  })();
  </script>
</body>
</html>
