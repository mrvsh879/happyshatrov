<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Office Birds — Level 1</title>
  <style>
    html,body{margin:0;height:100%;background:#050b14;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    canvas{display:block}
    .hud{
      position:fixed;left:14px;top:12px;z-index:10;display:flex;gap:10px;align-items:flex-start;
      color:#eaf6ff
    }
    .panel{
      padding:10px 12px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      font-size:12px;line-height:1.3;
      min-width:260px;
    }
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(124,247,255,.12);border:1px solid rgba(124,247,255,.22);font-weight:800}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:#fff;
      padding:9px 11px;border-radius:12px;
      font-weight:800;
    }
    button:hover{background:rgba(255,255,255,.12)}
    .goal{
      position:fixed;right:14px;top:12px;z-index:10;
      padding:10px 12px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:#eaf6ff;font-size:12px;line-height:1.3;
      width:240px;
      backdrop-filter: blur(8px);
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    #loader{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:999;
      background:radial-gradient(circle at 20% 20%, #10243e, #050b14);
      color:#e6f1ff;
    }
    #loaderBox{
      width:340px;padding:16px;border-radius:12px;
      background:rgba(255,255,255,0.06);
      box-shadow:0 10px 30px rgba(0,0,0,0.4);
      border:1px solid rgba(255,255,255,.12);
    }
    #bar{height:10px;background:#0b1c30;border-radius:6px;overflow:hidden;margin-top:8px}
    #bar>div{height:100%;width:0%;background:linear-gradient(90deg,#4fd1c5,#63b3ed);transition:width .2s}
    #pct{float:right;opacity:.7}
    code{background:rgba(255,255,255,.08);padding:1px 6px;border-radius:8px}
  </style>
</head>
<body>

<div id="loader">
  <div id="loaderBox">
    <div>Грузим офисный цирк… <span id="pct">0%</span></div>
    <div id="bar"><div></div></div>
    <div style="margin-top:10px;opacity:.7;font-size:12px">
      Пути должны быть: <code>assets/player/...</code>
    </div>
  </div>
</div>

<div class="hud">
  <div class="panel">
    <div class="row">
      <div><span class="tag">LEVEL 1</span> <b style="margin-left:6px">Office Birds</b></div>
      <button id="resetBtn">Reset</button>
    </div>
    <div style="margin-top:8px;opacity:.85">
      Зажми на “человеке на стуле” → потяни назад → отпусти.
    </div>
  </div>
</div>

<div class="goal">
  <b>Цель:</b> развали офисный домик и “сбей” работников в наушниках.
  <div style="opacity:.8;margin-top:6px">Пока не трогаешь — он качается вперёд/назад.</div>
</div>

<canvas id="c"></canvas>

<script>
/* ================== ASSETS ================== */
const ASSETS = {
  chair: "assets/player/chair.png",
  idle:  "assets/player/human_idle.png", // в этом спрайте уже есть кресло
  fly:   "assets/player/human_fly.png"
};

const IMG = {};
const loader = document.getElementById("loader");
const bar = document.querySelector("#bar > div");
const pct = document.getElementById("pct");

function loadImage(key, url, i, total){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=>{
      IMG[key]=img;
      const p = Math.round(((i+1)/total)*100);
      bar.style.width = p+"%";
      pct.textContent = p+"%";
      res();
    };
    img.onerror = ()=>rej(new Error("Failed to load: "+url));
    img.src = url + "?v=" + Date.now();
  });
}

/* ================== CANVAS ================== */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize", ()=>{ resize(); reset(); });
resize();

/* ================== CONFIG ================== */
const CFG = {
  gravity: 0.85,
  air: 0.992,
  floorYPad: 34,
  bounce: 0.22,
  friction: 0.78,

  // как Angry Birds: чем дальше оттянул — тем сильнее
  launchK: 0.23,
  maxPull: 220,

  // ✅ idle качание вперёд/назад (rotation)
  rockAngleDeg: 10,
  rockSpeed: 0.035
};

function anchorPoint(){
  return { x: Math.round(canvas.width*0.18), y: Math.round(canvas.height*0.74) };
}

/* ================== WORLD / LEVEL ================== */
const level = { blocks: [], dudes: [] };

function buildLevel(){
  level.blocks = [];
  level.dudes = [];

  const baseX = Math.round(canvas.width*0.82);
  const baseY = Math.round(canvas.height*0.80);

  const h = 20, colW = 20, colH = 95;

  // нижняя платформа
  level.blocks.push({x: baseX, y: baseY, w: 260, h: 26, hp: 999});

  // этаж 1
  level.blocks.push({x: baseX, y: baseY-70, w: 220, h: h, hp: 90});
  level.blocks.push({x: baseX-80, y: baseY-120, w: colW, h: colH, hp: 60});
  level.blocks.push({x: baseX+80, y: baseY-120, w: colW, h: colH, hp: 60});

  // этаж 2
  level.blocks.push({x: baseX, y: baseY-170, w: 180, h: h, hp: 70});
  level.blocks.push({x: baseX-60, y: baseY-220, w: colW, h: colH, hp: 50});
  level.blocks.push({x: baseX+60, y: baseY-220, w: colW, h: colH, hp: 50});

  // “офисные работники” (пока кружки)
  level.dudes.push({x: baseX, y: baseY-95, r: 14, alive: true});
  level.dudes.push({x: baseX, y: baseY-195, r: 14, alive: true});
}

function bg(){
  const g = ctx.createRadialGradient(canvas.width*0.2, canvas.height*0.2, 60, canvas.width*0.2, canvas.height*0.2, canvas.height);
  g.addColorStop(0, "rgba(16,44,78,0.9)");
  g.addColorStop(1, "rgba(5,11,20,1)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function drawGround(){
  ctx.fillStyle = "rgba(255,255,255,0.06)";
  ctx.fillRect(0, canvas.height-CFG.floorYPad, canvas.width, 6);
}

function drawBlocks(){
  for (const b of level.blocks){
    if (b.hp <= 0) continue;
    const k = Math.max(0.25, Math.min(1, b.hp/100));
    ctx.fillStyle = `rgba(255,255,255,${0.08*k})`;
    ctx.strokeStyle = `rgba(255,255,255,${0.18*k})`;
    ctx.lineWidth = 2;

    const x = b.x - b.w/2;
    const y = b.y - b.h/2;
    ctx.fillRect(x,y,b.w,b.h);
    ctx.strokeRect(x,y,b.w,b.h);
  }
}

function drawDudes(){
  for (const d of level.dudes){
    if (!d.alive) continue;
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.beginPath();
    ctx.arc(d.x,d.y,d.r,0,Math.PI*2);
    ctx.fill();

    // наушники
    ctx.strokeStyle = "rgba(124,247,255,0.9)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(d.x, d.y, d.r+4, Math.PI*0.15, Math.PI*0.85);
    ctx.stroke();
  }
}

/* ================== PLAYER ================== */
let dragging=false;
let hasLaunched=false;
let t=0;

const player = { x:0, y:0, vx:0, vy:0, flying:false };

// idle rig (точка опоры кресла)
const idleRig = { x:0, y:0 };

// пустой стул остаётся после запуска
const chairEmpty = { x:0, y:0, w:150, h:150 };

function reset(){
  const a = anchorPoint();
  hasLaunched = false;
  dragging = false;

  idleRig.x = a.x;
  idleRig.y = a.y;

  chairEmpty.x = a.x;
  chairEmpty.y = a.y;

  player.x = a.x;
  player.y = a.y - 70;
  player.vx = 0; player.vy = 0;
  player.flying = false;

  buildLevel();
}

function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

canvas.addEventListener("mousedown",(e)=>{
  if (hasLaunched) return;

  const dx = e.offsetX - idleRig.x;
  const dy = e.offsetY - (idleRig.y - 70);
  if (dx*dx + dy*dy < 70*70){
    dragging = true;
  }
});

canvas.addEventListener("mousemove",(e)=>{
  if(!dragging) return;

  const a = anchorPoint();
  const dx = e.offsetX - a.x;
  const dy = e.offsetY - a.y;
  const pull = Math.hypot(dx,dy);

  if (pull > CFG.maxPull){
    const k = CFG.maxPull / pull;
    player.x = a.x + dx*k;
    player.y = a.y + dy*k;
  } else {
    player.x = e.offsetX;
    player.y = e.offsetY;
  }
});

canvas.addEventListener("mouseup",()=>{
  if(!dragging) return;
  dragging = false;

  const a = anchorPoint();

  // ✅ Как Angry Birds: тянем назад — летит вперёд
  const dx = a.x - player.x;
  const dy = a.y - player.y;

  const pull = Math.hypot(dx,dy);
  if (pull < 25) {
    player.x = a.x;
    player.y = a.y - 70;
    return;
  }

  player.vx = dx * CFG.launchK;
  player.vy = dy * CFG.launchK;
  player.flying = true;
  hasLaunched = true;
});

document.getElementById("resetBtn").addEventListener("click", reset);

/* ================== PHYSICS & COLLISIONS ================== */
function rectHitCircle(rect, cx, cy, r){
  const rx = rect.x - rect.w/2;
  const ry = rect.y - rect.h/2;
  const px = clamp(cx, rx, rx+rect.w);
  const py = clamp(cy, ry, ry+rect.h);
  const dx = cx - px;
  const dy = cy - py;
  return (dx*dx + dy*dy) <= r*r;
}

function updatePhysics(){
  if (!hasLaunched){
    if (!dragging){
      const a = anchorPoint();
      player.x = a.x;
      player.y = a.y - 70;
    }
    return;
  }

  if (!player.flying) return;

  player.vy += CFG.gravity;
  player.vx *= CFG.air;
  player.vy *= CFG.air;
  player.x += player.vx;
  player.y += player.vy;

  const floorY = canvas.height - CFG.floorYPad;
  if (player.y > floorY){
    player.y = floorY;
    player.vy = -player.vy * CFG.bounce;
    player.vx *= CFG.friction;

    if (Math.abs(player.vx) < 0.25 && Math.abs(player.vy) < 0.25){
      player.flying = false;
    }
  }

  const r = 26;
  for (const b of level.blocks){
    if (b.hp <= 0) continue;
    if (rectHitCircle(b, player.x, player.y, r)){
      const dmg = Math.min(35, Math.hypot(player.vx, player.vy) * 1.2);
      b.hp -= dmg;
      player.vx *= -0.45;
      player.vy *= -0.35;
    }
  }

  for (const d of level.dudes){
    if (!d.alive) continue;
    const dx = player.x - d.x;
    const dy = player.y - d.y;
    if (dx*dx + dy*dy < (d.r + r)*(d.r + r)){
      d.alive = false;
      player.vx *= -0.25;
      player.vy *= -0.25;
    }
  }
}

/* ================== RENDER ================== */
function drawLaunchLine(){
  if (!dragging) return;
  const a = anchorPoint();

  ctx.strokeStyle="rgba(124,247,255,0.85)";
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(a.x,a.y);
  ctx.lineTo(player.x,player.y);
  ctx.stroke();

  // стойка (условная)
  ctx.fillStyle="rgba(255,255,255,0.10)";
  ctx.fillRect(a.x-10, a.y-60, 20, 130);
  ctx.fillStyle="rgba(124,247,255,0.18)";
  ctx.fillRect(a.x-7, a.y-54, 14, 28);
}

function drawPlayer(){
  const a = anchorPoint();

  // ✅ ДО запуска: idle + качание вперёд/назад (rotation)
  if (!hasLaunched){
    t += 1;

    const ang = Math.sin(t * CFG.rockSpeed) * (CFG.rockAngleDeg * Math.PI / 180);

    const w = 180, h = 180;

    // pivot — точка опоры кресла
    const pivotX = idleRig.x;
    const pivotY = idleRig.y;

    ctx.save();
    ctx.translate(pivotX, pivotY);

    // небольшой “боб” (можно убрать если не надо)
    const bob = Math.abs(Math.sin(t * CFG.rockSpeed)) * 1.5;
    ctx.translate(0, bob);

    ctx.rotate(ang);

    // важная подгонка: где у спрайта “низ кресла”
    // можно подкрутить 0.62 (примерно 0.58–0.70)
    ctx.drawImage(IMG.idle, -w/2, -h*0.62, w, h);

    ctx.restore();
    return;
  }

  // ✅ ПОСЛЕ запуска: пустой стул остаётся
  ctx.drawImage(
    IMG.chair,
    chairEmpty.x-chairEmpty.w/2,
    chairEmpty.y-chairEmpty.h/2,
    chairEmpty.w,
    chairEmpty.h
  );

  // летящий человек
  const w = 130, h = 130;
  ctx.drawImage(IMG.fly, player.x-w/2, player.y-h/2, w, h);
}

function loop(){
  bg();
  drawGround();
  drawBlocks();
  drawDudes();
  drawLaunchLine();
  drawPlayer();
  updatePhysics();
  requestAnimationFrame(loop);
}

/* ================== BOOT ================== */
(async()=>{
  const entries = Object.entries(ASSETS);
  for(let i=0;i<entries.length;i++){
    await loadImage(entries[i][0], entries[i][1], i, entries.length);
  }
  loader.remove();
  reset();
  loop();
})().catch(err=>{
  console.error(err);
  pct.textContent = "ERR";
  document.querySelector("#loaderBox").insertAdjacentHTML(
    "beforeend",
    `<div style="margin-top:10px;color:#ffb4b4;font-size:12px">
      Ошибка загрузки: <code>${String(err.message||err)}</code><br>
      Проверь файлы:<br>
      <code>assets/player/chair.png</code><br>
      <code>assets/player/human_idle.png</code><br>
      <code>assets/player/human_fly.png</code>
    </div>`
  );
});
</script>
</body>
</html>
