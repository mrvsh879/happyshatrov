<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Office Birds ‚Äî Angry-ish MVP</title>

  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#06121f; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #wrap { position:fixed; inset:0; }
    canvas { display:block; width:100%; height:100%; }

    .hud { position:fixed; left:16px; top:16px; z-index:10; display:flex; gap:12px; align-items:flex-start; pointer-events:none; }
    .panel { background:rgba(9,18,28,.55); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; color:rgba(255,255,255,.92); backdrop-filter: blur(6px); box-shadow:0 10px 30px rgba(0,0,0,.25); min-width:260px; pointer-events:none; }
    .panel h1{ font-size:14px; margin:0 0 6px 0; font-weight:900; letter-spacing:.2px; }
    .panel small{ display:block; opacity:.88; font-size:12px; line-height:1.35; }

    .btnbar{ pointer-events:auto; display:flex; gap:10px; align-items:center; }
    button{ pointer-events:auto; background:rgba(255,255,255,.10); color:rgba(255,255,255,.92); border:1px solid rgba(255,255,255,.16); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:900; }
    button:hover{ background:rgba(255,255,255,.16); }

    .right{ position:fixed; top:16px; right:16px; z-index:10; width:340px; pointer-events:none; }
    .kv{ display:grid; grid-template-columns:1fr auto; gap:6px 10px; margin-top:8px; font-size:12px; opacity:.95; }
    .kv div:nth-child(2n){ font-weight:900; }

    .toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      z-index:10; padding:7px 12px; font-size:12px; color:rgba(255,255,255,.94);
      background:rgba(0,0,0,.44); border:1px solid rgba(255,255,255,.12);
      border-radius:999px; backdrop-filter: blur(6px);
      pointer-events:none; opacity:0; transition:opacity .18s ease;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .toast.show{ opacity:1; }
  </style>
</head>

<body>
  <div class="hud">
    <div class="panel">
      <h1><span style="opacity:.9">LEVEL 1</span> &nbsp; Office Birds</h1>
      <small><b>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</b> –∑–∞–∂–º–∏ —á–µ–ª–æ–≤–µ—á–∫–∞ ‚Üí –ø–æ—Ç—è–Ω–∏ –Ω–∞–∑–∞–¥ ‚Üí –æ—Ç–ø—É—Å—Ç–∏.</small>
      <small>–î–æ–º–∏–∫ ‚Äú–æ–∂–∏–≤–∞–µ—Ç‚Äù –ø–æ—Å–ª–µ –≤—ã—Å—Ç—Ä–µ–ª–∞. –†–∞–∑—Ä—É—à–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.</small>
      <div class="kv">
        <div>–°—á—ë—Ç:</div><div id="score">0</div>
        <div>–°–ª–æ–º–∞–Ω–æ:</div><div id="broken">0</div>
        <div>–ü–æ–ø–∞–¥–∞–Ω–∏–π:</div><div id="hits">0</div>
        <div>–ü–æ–±–µ–¥:</div><div id="wins">0</div>
      </div>
    </div>

    <div class="btnbar">
      <button id="resetBtn">Reset</button>
      <button id="debugBtn">DEBUG</button>
    </div>
  </div>

  <div class="right">
    <div class="panel">
      <h1>–¶–µ–ª—å</h1>
      <small>–í—ã–±–µ–π –≤—Å–µ—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ –Ω–∞—É—à–Ω–∏–∫–∞—Ö üòà</small>
      <small>–ü–æ—Å–ª–µ –≤—ã—Å—Ç—Ä–µ–ª–∞: 2‚Äì3 —Å–µ–∫ —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è ‚Üí –∞–≤—Ç–æ-—Ä–µ—Å–ø–∞–≤–Ω ‚Äú–ø—Ç–∏—Ü—ã‚Äù.</small>
      <div class="kv">
        <div>–°—Ç–∞—Ç—É—Å:</div><div id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>
  </div>

  <div id="wrap"><canvas id="c"></canvas></div>
  <div id="toast" class="toast">‚Ä¶</div>

  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

  <script>
  (function(){
    "use strict";

    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    function toast(msg, ms=1400){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), ms);
    }

    function loadImage(src){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = ()=>resolve(img);
        img.onerror = ()=>reject(new Error("–ù–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –∫–∞—Ä—Ç–∏–Ω–∫–∞: " + src));
        img.src = src + (src.includes("?") ? "&" : "?") + "v=" + Date.now();
      });
    }

    const ASSETS = {
      bg: "assets/bg_office.png",
      beam: "assets/office/beam.png",
      pillar: "assets/office/pillar.png",
      manager: "assets/office/manager.png",
      humanIdle: "assets/player/human_idle.png",
      humanFly: "assets/player/human_fly.png"
    };

    const {
      Engine, Render, Runner, World, Bodies, Body,
      Constraint, Mouse, MouseConstraint, Events, Composite, Query, Vector
    } = Matter;

    let engine, world, render, runner, ground;
    let mouse, mouseConstraint;

    let bird = null;
    let birdLaunched = false;
    let birdRespawnTimer = null;

    let slingshot = null;
    let slingAnchor = null;
    let draggingBird = false;
    let canLaunch = true;

    let DEBUG = false;

    const structure = {
      pillars: [],
      beams: [],
      managers: [],
      activated: false // –¥–æ–º–∏–∫ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã—Å—Ç—Ä–µ–ª–∞
    };

    const stats = { score:0, broken:0, hits:0, wins:0 };

    // –ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const MANAGER_HIT_SPEED = 4.0;      // —Å–∫–æ—Ä–æ—Å—Ç—å —É–¥–∞—Ä–∞ –¥–ª—è "–≤—ã–±–∏–≤–∞–Ω–∏—è" –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    const BEAM_SPLIT_IMPACT = 6.4;      // —É–¥–∞—Ä –¥–ª—è —Ä–∞—Å–∫–æ–ª–∞ –±–∞–ª–∫–∏
    const AUTO_RESPAWN_MS = 2600;

    // –õ–µ–π–∞—É—Ç: –±–ª–∏–∂–µ –∫ –∏–≥—Ä–æ–∫—É, –∫–∞–∫ —É —Ç–µ–±—è
    const LAYOUT = {
      floorHeight: 90,
      birdStartX: 190,
      birdStartYOffset: 165,

      houseCenterX: () => Math.round(window.innerWidth * 0.58),
      houseBaseY: () => Math.round(window.innerHeight - LAYOUT.floorHeight),
      houseWidth: 360,

      yBottomBeam: () => LAYOUT.houseBaseY() - 42,
      yMidBeam: () => LAYOUT.houseBaseY() - 142,
      yTopBeam: () => LAYOUT.houseBaseY() - 242,

      managersCount: 3
    };

    // –†–∞–∑–º–µ—Ä—ã "—Ö–∏—Ç–±–æ–∫—Å–æ–≤" –ø–æ–¥ —Å–ø—Ä–∞–π—Ç—ã
    const SPRITE_TARGET = {
      pillarH: 260,
      beamW: 340,

      birdBodyRadius: 42,
      birdWIdle: 120,
      birdWFly: 92,

      managerW: 74
    };

    $("status").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤‚Ä¶";

    Promise.all([
      loadImage(ASSETS.bg),
      loadImage(ASSETS.beam),
      loadImage(ASSETS.pillar),
      loadImage(ASSETS.manager),
      loadImage(ASSETS.humanIdle),
      loadImage(ASSETS.humanFly)
    ]).then(([imgBg, imgBeam, imgPillar, imgManager, imgIdle, imgFly])=>{
      start({imgBg, imgBeam, imgPillar, imgManager, imgIdle, imgFly});
    }).catch((e)=>{
      console.error(e);
      $("status").textContent = "–û—à–∏–±–∫–∞ PNG";
      toast("PNG –æ—à–∏–±–∫–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å assets/‚Ä¶", 2500);
    });

    function updateHUD(){
      $("score").textContent  = String(stats.score);
      $("broken").textContent = String(stats.broken);
      $("hits").textContent   = String(stats.hits);
      $("wins").textContent   = String(stats.wins);
    }

    function start(IMGS){
      $("status").textContent = "–ó–∞–ø—É—Å–∫‚Ä¶";

      const canvas = $("c");
      const wrap = $("wrap");

      engine = Engine.create();
      world = engine.world;
      world.gravity.y = 1.05;

      render = Render.create({
        element: wrap,
        canvas,
        engine,
        options: {
          width: window.innerWidth,
          height: window.innerHeight,
          wireframes: false,
          background: ASSETS.bg,
          pixelRatio: window.devicePixelRatio || 1
        }
      });

      runner = Runner.create();

      // –ü–æ–ª
      ground = Bodies.rectangle(
        window.innerWidth/2,
        window.innerHeight - LAYOUT.floorHeight/2,
        window.innerWidth + 800,
        LAYOUT.floorHeight,
        {
          isStatic: true,
          friction: 1.0,
          restitution: 0.0,
          render: DEBUG ? { fillStyle:"rgba(255,255,255,0.10)" } : { fillStyle:"rgba(0,0,0,0)" }
        }
      );
      World.add(world, ground);

      // –ú—ã—à—å (—É—á—ë—Ç pixelRatio –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
      mouse = Mouse.create(canvas);
      mouse.pixelRatio = render.options.pixelRatio;

      // MouseConstraint –æ—Å—Ç–∞–≤–ª—è–µ–º, –Ω–æ –º—ã —Å–∞–º–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–º, —á—Ç–æ –º–æ–∂–Ω–æ —Ö–≤–∞—Ç–∞—Ç—å
      mouseConstraint = MouseConstraint.create(engine, {
        mouse,
        constraint: { stiffness: 0.14, damping: 0.16, render: { visible:false } }
      });
      World.add(world, mouseConstraint);
      render.mouse = mouse;

      buildStructure(IMGS);
      spawnBird(IMGS);
      setupSlingshot(IMGS);
      bindGameplay(IMGS);

      Render.run(render);
      Runner.run(runner, engine);

      $("resetBtn").addEventListener("click", ()=>resetAll(IMGS));
      $("debugBtn").addEventListener("click", ()=>{
        DEBUG = !DEBUG;
        toast(DEBUG ? "DEBUG: ON" : "DEBUG: OFF", 900);
        resetAll(IMGS);
      });

      window.addEventListener("resize", ()=>onResize(IMGS));

      $("status").textContent = "–ì–æ—Ç–æ–≤–æ";
      updateHUD();
    }

    function onResize(IMGS){
      render.canvas.width  = window.innerWidth;
      render.canvas.height = window.innerHeight;
      render.options.width  = window.innerWidth;
      render.options.height = window.innerHeight;
      resetAll(IMGS);
    }

    function resetAll(IMGS){
      if (birdRespawnTimer){ clearTimeout(birdRespawnTimer); birdRespawnTimer = null; }

      Composite.clear(world, false);
      World.add(world, ground);
      World.add(world, mouseConstraint);

      stats.score = 0; stats.broken = 0; stats.hits = 0; stats.wins = 0;
      updateHUD();

      structure.pillars = [];
      structure.beams = [];
      structure.managers = [];
      structure.activated = false;

      bird = null;
      slingshot = null;
      slingAnchor = null;

      birdLaunched = false;
      draggingBird = false;
      canLaunch = true;

      buildStructure(IMGS);
      spawnBird(IMGS);
      setupSlingshot(IMGS);

      $("status").textContent = "–ì–æ—Ç–æ–≤–æ";
    }

    // ====== –°–¢–†–û–ò–ú –î–û–ú–ò–ö: –Ω–∞ —Å—Ç–∞—Ä—Ç–µ —Å—Ç–∞—Ç–∏—á–Ω—ã–π, –±–µ–∑ –¥—Ä–æ–∂–∏ ======
    function buildStructure(IMGS){
      const baseY = LAYOUT.houseBaseY();
      const cx = LAYOUT.houseCenterX();
      const w = LAYOUT.houseWidth;

      const leftX  = cx - Math.round(w/2);
      const rightX = cx + Math.round(w/2);

      const pillarScale = SPRITE_TARGET.pillarH / IMGS.imgPillar.height;
      const beamScale   = SPRITE_TARGET.beamW   / IMGS.imgBeam.width;

      const pillarH = IMGS.imgPillar.height * pillarScale;
      const pillarW = IMGS.imgPillar.width  * pillarScale;

      const pLeft = Bodies.rectangle(leftX, baseY - pillarH/2, pillarW, pillarH, {
        isStatic: true,
        render: DEBUG
          ? { fillStyle:"rgba(0,210,255,0.20)", strokeStyle:"rgba(110,240,255,0.9)", lineWidth:2 }
          : { sprite:{ texture: ASSETS.pillar, xScale: pillarScale, yScale: pillarScale } }
      });

      const pRight = Bodies.rectangle(rightX, baseY - pillarH/2, pillarW, pillarH, {
        isStatic: true,
        render: DEBUG
          ? { fillStyle:"rgba(0,210,255,0.20)", strokeStyle:"rgba(110,240,255,0.9)", lineWidth:2 }
          : { sprite:{ texture: ASSETS.pillar, xScale: pillarScale, yScale: pillarScale } }
      });

      const beamW = IMGS.imgBeam.width  * beamScale;
      const beamH = IMGS.imgBeam.height * beamScale;

      function makeBeam(x,y,tag){
        const b = Bodies.rectangle(x, y, beamW, beamH, {
          isStatic: true,
          friction: 0.95,
          restitution: 0.02,
          density: 0.0022,
          chamfer: { radius: 4 },
          render: DEBUG
            ? { fillStyle:"rgba(255,120,0,0.25)", strokeStyle:"rgba(255,170,90,0.9)", lineWidth:2 }
            : { sprite:{ texture: ASSETS.beam, xScale: beamScale, yScale: beamScale } }
        });
        b.__isBeam = true;
        b.__beamScale = beamScale;
        b.__beamTag = tag;
        b.__split = false;
        return b;
      }

      const bTop = makeBeam(cx, LAYOUT.yTopBeam(), "top");
      const bMid = makeBeam(cx, LAYOUT.yMidBeam(), "mid");
      const bBot = makeBeam(cx, LAYOUT.yBottomBeam(), "bot");

      // Managers: —Å—Ç–∞—Ç–∏—á–Ω—ã –¥–æ –≤—ã—Å—Ç—Ä–µ–ª–∞
      const managers = [];
      const mScale = SPRITE_TARGET.managerW / IMGS.imgManager.width;
      const mW = IMGS.imgManager.width * mScale;
      const mH = IMGS.imgManager.height * mScale;

      for (let i=0; i<LAYOUT.managersCount; i++){
        const t = (i+1)/(LAYOUT.managersCount+1);
        const x = cx - w*0.24 + t*(w*0.48);
        const y = LAYOUT.yMidBeam() - beamH/2 - mH/2 + 10;

        const m = Bodies.rectangle(x, y, mW, mH, {
          isStatic: true,
          friction: 0.85,
          restitution: 0.02,
          density: 0.002,
          render: DEBUG
            ? { fillStyle:"rgba(255,255,255,0.16)", strokeStyle:"rgba(255,255,255,0.9)", lineWidth:2 }
            : { sprite:{ texture: ASSETS.manager, xScale: mScale, yScale: mScale } }
        });
        m.__isManager = true;
        m.__alive = true;
        managers.push(m);
      }

      structure.pillars = [pLeft, pRight];
      structure.beams = [bTop, bMid, bBot];
      structure.managers = managers;

      World.add(world, [pLeft, pRight, bTop, bMid, bBot, ...managers]);
    }

    // –î–æ–º–∏–∫ ‚Äú–æ–∂–∏–≤–∞–µ—Ç‚Äù –ø–æ—Å–ª–µ –≤—ã—Å—Ç—Ä–µ–ª–∞
    function activateStructure(){
      if (structure.activated) return;
      structure.activated = true;

      for (const b of structure.beams){
        Body.setStatic(b, false);
        b.frictionAir = 0.010;
      }
      for (const m of structure.managers){
        Body.setStatic(m, false);
        m.frictionAir = 0.020;
      }
    }

    function spawnBird(IMGS){
      const baseY = window.innerHeight - LAYOUT.floorHeight;
      const start = { x: LAYOUT.birdStartX, y: baseY - LAYOUT.birdStartYOffset };

      const idleScale = SPRITE_TARGET.birdWIdle / IMGS.imgIdle.width;
      const flyScale  = SPRITE_TARGET.birdWFly  / IMGS.imgFly.width;

      bird = Bodies.circle(start.x, start.y, SPRITE_TARGET.birdBodyRadius, {
        restitution: 0.18,
        friction: 0.95,
        frictionAir: 0.012,
        density: 0.0045,
        render: DEBUG
          ? { fillStyle:"rgba(255,0,0,0.22)", strokeStyle:"rgba(255,0,0,0.9)", lineWidth:2 }
          : { sprite:{ texture: ASSETS.humanIdle, xScale: idleScale, yScale: idleScale } }
      });

      // collisionFilter –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º —Ä–∞–∑—Ä–µ—à–∞—Ç—å —Ö–≤–∞—Ç —Ç–æ–ª—å–∫–æ –ø—Ç–∏—á–∫–∏
      bird.collisionFilter.category = 0x0002;
      bird.collisionFilter.mask = 0xFFFF;

      bird.__start = start;
      bird.__flyTexture = ASSETS.humanFly;
      bird.__idleTexture = ASSETS.humanIdle;
      bird.__flyScale = flyScale;
      bird.__idleScale = idleScale;

      birdLaunched = false;
      World.add(world, bird);
    }

    function setBirdFly(){
      if (!bird || DEBUG) return;
      bird.render.sprite.texture = bird.__flyTexture;
      bird.render.sprite.xScale = bird.__flyScale;
      bird.render.sprite.yScale = bird.__flyScale;
    }
    function setBirdIdle(){
      if (!bird || DEBUG) return;
      bird.render.sprite.texture = bird.__idleTexture;
      bird.render.sprite.xScale = bird.__idleScale;
      bird.render.sprite.yScale = bird.__idleScale;
    }

    // –†–æ–≥–∞—Ç–∫–∞ (–∫–∞–∫ Angry Birds): —è–∫–æ—Ä—å + constraint –∫ –ø—Ç–∏—Ü–µ
    function setupSlingshot(){
      const start = bird.__start;
      slingAnchor = { x: start.x, y: start.y };

      slingshot = Constraint.create({
        pointA: { x: slingAnchor.x, y: slingAnchor.y },
        bodyB: bird,
        pointB: { x: 0, y: 0 },
        stiffness: 0.035,
        damping: 0.06,
        length: 0,
        render: { visible: DEBUG }
      });

      World.add(world, slingshot);

      // ‚Äú–†–µ–∞–ª—å–Ω–∞—è‚Äù –ª–∏–Ω–∏–π–∫–∞-—Ä–µ–∑–∏–Ω–∫–∞, –µ—Å–ª–∏ DEBUG –≤—ã–∫–ª—é—á–µ–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
      slingshot.render.visible = DEBUG;
    }

    function detachSlingshot(){
      if (!slingshot) return;
      World.remove(world, slingshot);
      slingshot = null;
    }

    function scheduleBirdRespawn(IMGS, delayMs){
      if (birdRespawnTimer) return;
      birdRespawnTimer = setTimeout(()=>{
        birdRespawnTimer = null;

        // —É–¥–∞–ª—è–µ–º –ø—Ç–∏—Ü—É (–¥–æ–º–∏–∫ –æ—Å—Ç–∞—ë—Ç—Å—è —Å–ª–æ–º–∞–Ω–Ω—ã–º!)
        if (bird){
          World.remove(world, bird);
          bird = null;
        }
        if (slingshot){
          World.remove(world, slingshot);
          slingshot = null;
        }

        spawnBird(IMGS);
        setupSlingshot(IMGS);
        setBirdIdle();

        birdLaunched = false;
        draggingBird = false;
        canLaunch = true;

        $("status").textContent = "–ì–æ—Ç–æ–≤–æ";
      }, delayMs);
    }

    // –†–∞—Å–∫–æ–ª –±–∞–ª–∫–∏: –∑–∞–º–µ–Ω—è–µ–º 1 —Ç–µ–ª–æ –Ω–∞ 2 –∫–æ—Ä–æ—Ç–∫–∏—Ö
    function splitBeam(beam){
      if (!beam || !beam.__isBeam || beam.__split) return;
      beam.__split = true;

      const pos = beam.position;
      const angle = beam.angle;
      const w = beam.bounds.max.x - beam.bounds.min.x;
      const h = beam.bounds.max.y - beam.bounds.min.y;

      // —Ä–∞–∑–º–µ—Ä—ã —á–∞—Å—Ç–µ–π
      const gap = 10;
      const w2 = Math.max(60, (w - gap) / 2);

      // –≤–µ–∫—Ç–æ—Ä –≤–¥–æ–ª—å –±–∞–ª–∫–∏
      const dir = Vector.rotate({ x: 1, y: 0 }, angle);
      const off = Vector.mult(dir, (w2/2 + gap/2));

      const leftPos  = Vector.sub(pos, off);
      const rightPos = Vector.add(pos, off);

      function makePiece(p){
        const piece = Bodies.rectangle(p.x, p.y, w2, h, {
          isStatic: false,
          friction: 0.95,
          restitution: 0.02,
          density: 0.0022,
          chamfer: { radius: 4 },
          render: DEBUG
            ? { fillStyle:"rgba(255,120,0,0.25)", strokeStyle:"rgba(255,170,90,0.95)", lineWidth:2 }
            : { sprite:{ texture: ASSETS.beam, xScale: beam.__beamScale * (w2 / (SPRITE_TARGET.beamW)), yScale: beam.__beamScale } }
        });
        piece.__isBeam = true;
        piece.__split = true; // —á—Ç–æ–±—ã –Ω–µ ‚Äú–¥–µ–ª–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ‚Äù
        Body.setAngle(piece, angle);
        Body.setVelocity(piece, beam.velocity);
        Body.setAngularVelocity(piece, beam.angularVelocity);
        piece.frictionAir = beam.frictionAir || 0.010;
        return piece;
      }

      const p1 = makePiece(leftPos);
      const p2 = makePiece(rightPos);

      // —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –±–∞–ª–∫—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏
      World.remove(world, beam);
      const idx = structure.beams.indexOf(beam);
      if (idx >= 0) structure.beams.splice(idx, 1);
      structure.beams.push(p1, p2);
      World.add(world, [p1, p2]);

      stats.broken += 1;
      stats.score += 15;
      updateHUD();
      toast("–ë–ê–õ–ö–ê –¢–†–ï–°–ù–£–õ–ê üí•", 900);
    }

    function checkWin(){
      // –ü–æ–±–µ–¥–∞, –µ—Å–ª–∏ –≤—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –≤—ã–±–∏—Ç—ã
      const alive = structure.managers.some(m => m.__alive);
      if (!alive){
        stats.wins += 1;
        stats.score += 100;
        updateHUD();
        toast("–ü–û–ë–ï–î–ê! –í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –≤—ã–±–∏—Ç—ã üèÜ", 1600);

        // —á—É—Ç—å –ø–∞—É–∑–∞ ‚Äî –∏ —Ä–µ—Å–ø–∞–≤–Ω–∏–º –ø—Ç–∏—Ü—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏/–ø–æ–∏–≥—Ä–∞—Ç—å
        scheduleBirdRespawn(null, 600);
      }
    }

    function bindGameplay(IMGS){
      // –ñ—ë—Å—Ç–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º: —Ç—è–Ω—É—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ bird –∏ —Ç–æ–ª—å–∫–æ –¥–æ –∑–∞–ø—É—Å–∫–∞
      Events.on(mouseConstraint, "mousedown", ()=>{
        if (!bird || birdLaunched || !canLaunch) return;

        // –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –º—ã—à—å—é –ø–æ –ø—Ç–∏—Ü–µ (—Å —É—á—ë—Ç–æ–º —Ä–∞–¥–∏—É—Å–∞)
        const bodies = [bird];
        const found = Query.point(bodies, mouse.position);
        if (found && found.length){
          draggingBird = true;
          $("status").textContent = "–¢—è–Ω–∏‚Ä¶";
        }
      });

      Events.on(mouseConstraint, "mousemove", ()=>{
        if (!bird || !draggingBird || birdLaunched) return;

        // –æ–≥—Ä–∞–Ω–∏—á–∏–º –Ω–∞—Ç—è–∂–∫—É
        const start = bird.__start;
        const mp = mouse.position;

        const dx = mp.x - start.x;
        const dy = mp.y - start.y;

        const pullMax = 170;
        const dist = Math.hypot(dx, dy) || 1;
        const k = Math.min(1, pullMax / dist);

        const px = start.x + dx * k;
        const py = start.y + dy * k;

        Body.setPosition(bird, { x: px, y: py });
        Body.setVelocity(bird, { x: 0, y: 0 });
        Body.setAngularVelocity(bird, 0);
      });

      Events.on(mouseConstraint, "mouseup", ()=>{
        if (!bird || !draggingBird || birdLaunched) { draggingBird = false; return; }

        draggingBird = false;
        if (!canLaunch) return;

        // –∑–∞–ø—É—Å–∫–∞–µ–º
        activateStructure();
        setBirdFly();

        // —É–±–∏—Ä–∞–µ–º constraint ‚Äî Matter —Å–∞–º ‚Äú–≤—ã—Å—Ç—Ä–µ–ª–∏—Ç‚Äù –æ—Ç –Ω–∞—Ç—è–∂–µ–Ω–∏—è
        detachSlingshot();

        birdLaunched = true;
        canLaunch = false;

        stats.score += 1;
        updateHUD();
        $("status").textContent = "–ü–æ–ª–µ—Ç–µ–ª!";

        scheduleBirdRespawn(IMGS, AUTO_RESPAWN_MS);
      });

      // –ö–æ–ª–ª–∏–∑–∏–∏: –º–µ–Ω–µ–¥–∂–µ—Ä—ã + —Ä–∞—Å–∫–æ–ª –±–∞–ª–æ–∫
      Events.on(engine, "collisionStart", (event)=>{
        if (!structure.activated) return;

        for (const pair of event.pairs){
          const a = pair.bodyA, b = pair.bodyB;

          // —Å–∫–æ—Ä–æ—Å—Ç—å —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
          const va = Math.hypot(a.velocity.x, a.velocity.y);
          const vb = Math.hypot(b.velocity.x, b.velocity.y);
          const impact = Math.abs(va - vb);

          // –ú–µ–Ω–µ–¥–∂–µ—Ä –≤—ã–±–∏—Ç
          if ((a.__isManager && b===bird) || (b.__isManager && a===bird)){
            const m = a.__isManager ? a : b;
            const v = bird ? Math.hypot(bird.velocity.x, bird.velocity.y) : 0;

            if (m.__alive && v > MANAGER_HIT_SPEED){
              m.__alive = false;
              stats.hits += 1;
              stats.score += 25;
              updateHUD();
              toast("–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–µ—Ö–∞–ª üòµ", 800);
              checkWin();
            }
          }

          // –†–∞—Å–∫–æ–ª –±–∞–ª–∫–∏ –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º —É–¥–∞—Ä–µ (–ª—é–±—ã–º —Ç–µ–ª–æ–º)
          if (impact > BEAM_SPLIT_IMPACT){
            if (a.__isBeam) splitBeam(a);
            if (b.__isBeam) splitBeam(b);
          }
        }
      });

      // –ö–æ–Ω—Ç—Ä–æ–ª—å –≤—ã–ª–µ—Ç–∞ + ‚Äú—É—Å–ø–æ–∫–æ–µ–Ω–∏—è‚Äù
      Events.on(engine, "beforeUpdate", ()=>{
        if (!bird) return;

        if (birdLaunched){
          const out =
            bird.position.x < -260 ||
            bird.position.x > window.innerWidth + 260 ||
            bird.position.y > window.innerHeight + 520 ||
            bird.position.y < -520;

          if (out) scheduleBirdRespawn(IMGS, 200);

          const speed = Math.hypot(bird.velocity.x, bird.velocity.y);
          if (speed < 0.35 && bird.position.y > window.innerHeight - LAYOUT.floorHeight - 220){
            setBirdIdle();
          }
        }

        // –±–ª–æ–∫–∏—Ä—É–µ–º ‚Äú–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫‚Äù –¥–æ —Ä–µ—Å–ø–∞–≤–Ω–∞
        if (!birdLaunched && !draggingBird){
          canLaunch = true;
        }
      });
    }

  })();
  </script>
</body>
</html>
